// Zentrales i18n-Modul mit Sprachressourcen und Helfern
(function() {
    const resources = {
        de: {
            'app.title': 'Half-Life: Alyx Translation Tool',
            'loading.project': 'Projekt wird geladen...',
            'loading.retry': 'Erneut versuchen',
            'sidebar.projects': 'üéÆ Projekte',
            'project.add': '+ Neues Projekt',
            'tab.project': 'Projekt',
            'tab.tools': 'Werkzeuge',
            'tab.media': 'Medien',
            'tab.system': 'System',
            'tab.search': 'Suche & Verlauf',
            'toolbar.project.title': 'Projekt',
            'toolbar.tools.title': 'Werkzeuge',
            'toolbar.media.title': 'Medien',
            'toolbar.system.title': 'System',
            'toolbar.search.title': 'Suche & Verlauf',
            'button.import': 'üì• Import',
            'button.ccImport': 'üé¨ Untertitel',
            'button.folder': 'üìÅ Ordner',
            'label.addFiles': 'Dateien hinzuf√ºgen',
            'placeholder.addFiles': 'Dateinamen eingeben (einer pro Zeile)...',
            'button.addFiles': 'Hinzuf√ºgen',
            'button.gptScore': 'Bewerten (GPT)',
            'button.randomProject': 'üé≤ Zufall',
            'button.wordList': 'üìö W√∂rter',
            'button.generateEmotions': 'Emotionen (DE)',
            'button.sendElevenLabs': 'An ElevenLabs schicken',
            'button.assignAudio': 'üîä Audio-Datei zuordnen',
            'button.importZip': 'ZIP importieren',
            'button.copyAssistant': 'Kopierhilfe',
            'button.copyAssistant2': 'Kopierhilfe 2',
            // √úbersetzungen f√ºr die Kopierhilfe inkl. Platzhalter
            'copyAssistant.status.complete': 'Kopierhilfe abgeschlossen',
            'copyAssistant.progress.files': 'Datei {current} von {total}',
            'copyAssistant.progress.steps': 'Schritt {current} von {total}',
            'button.copyEmotions': 'Emotionen kopieren',
            'button.subtitleSearchAll': 'UT-Suche alles',
            'button.dubbingLog': 'üìù Protokoll',
            'button.devTools': 'üêû DevTools',
            'button.debugReport': 'üìã Debug-Bericht',
            'settings.title': '‚öôÔ∏è Einstellungen',
            'settings.cleanupDuplicates': 'üßπ Duplikate bereinigen',
            'settings.audioDuplicates': 'üéµ Audio-Duplikate',
            'settings.backup': 'üíæ Backup',
            'settings.elevenLabs': 'üîä ElevenLabs API',
            'settings.gpt': 'üí¨ ChatGPT API',
            'settings.resetDb': 'üîÑ Reset DB',
            'settings.cleanupProjects': 'üîÑ Projekte bereinigen',
            'settings.repairFolders': 'üîß Ordner reparieren',
            'settings.language': 'üåê Sprache',
            'toolbar.media.videos': 'üé¨ Videos',
            'label.mode': 'Spiel',
            'label.workshop': 'Workshop',
            'label.mapToggle': '+map',
            'placeholder.level': 'Level',
            'button.start': 'Starten',
            'option.godmode': 'Godmode',
            'option.ammo': 'Unendliche Munition',
            'option.console': 'Entwicklerkonsole',
            'system.menu': 'Verwaltung',
            'system.migration.title': 'Migration',
            'system.migration.start': 'Migration starten',
            'system.migration.load': 'Migration laden',
            'system.migration.process': 'Daten migrieren',
            'system.storage.title': 'Speicher',
            'system.storage.switch': 'Wechseln',
            'system.storage.folder': 'üìÇ Speicherordner',
            'system.storage.cleanup': 'Aufr√§umen',
            'storage.dialog.title': 'Speichermodus w√§hlen',
            'storage.dialog.description': 'Bitte Speichersystem ausw√§hlen:',
            'storage.dialog.local': 'LocalStorage',
            'storage.dialog.indexed': 'Neues System',
            'storage.mode.local': 'LocalStorage',
            'storage.mode.file': 'Datei-Modus',
            'storage.mode.fileOpfs': 'Datei-Modus (OPFS)',
            'storage.mode.fileBase64': 'Datei-Modus (Base64)',
            'storage.switch.toLocal': 'Wechsel zu LocalStorage',
            'storage.switch.toFile': 'Wechsel zu Datei-Modus',
            'storage.switch.loading': 'Lade {mode}...',
            'storage.switch.toast': 'Wechsle zu {mode} (ohne Kopieren der Daten)',
            'storage.switch.loaded': '{mode} geladen',
            'storage.switch.now': 'Jetzt im {mode}',
            'storage.persist.denied': 'Persistenter Speicher wurde nicht gew√§hrt',
            'storage.persist.granted': 'Lokaler Speicher gesichert, verf√ºgbar: {free} MB',
            'storage.visualize.indexedOnly': '‚Äû{key}‚Äú liegt im neuen Speichersystem.',
            'storage.visualize.localOnly': '‚Äû{key}‚Äú liegt noch im LocalStorage.',
            'storage.visualize.both': '‚Äû{key}‚Äú existiert in beiden Speichersystemen.',
            'storage.visualize.none': '‚Äû{key}‚Äú wurde in keinem Speichersystem gefunden.',
            'storage.folder.unavailable': 'Pfad zum neuen Speichersystem ist nicht verf√ºgbar',
            'storage.usage.label': '{used} MB von {quota} MB',
            'storage.cleanup.last': 'Zuletzt bereinigt am {date}',
            'storage.cleanup.never': 'Noch nie bereinigt',
            'storage.cleanup.toast': 'Speicher bereinigt',
            'search.placeholder': 'Live-Suche: Dateiname oder Text... (Gro√ü-/Kleinschreibung, Punkte ignoriert)',
            'search.copy.remainder': 'Reste-Modus',
            'search.copy.time': 'Zeit voranstellen',
            'search.copy.dashes': '--- anh√§ngen',
            'search.copy.speed': '‚Äûextrem schnell reden‚Äú erg√§nzen',
            'search.sort': 'Sortierung:',
            'search.sort.position': 'Position',
            'search.sort.filename': 'Dateiname',
            'search.sort.folder': 'Ordner',
            'search.sort.completion': 'Fertig',
            'progress.total': '0% vollst√§ndig',
            'progress.folders': '0 Ordner',
            'progress.global': '0% gesamt',
            'empty.title': 'Keine Dateien im Projekt',
            'empty.hint': 'F√ºge Dateien √ºber die Suche oder das Eingabefeld hinzu.',
            'empty.tips': 'üí° Tipps:<br>‚Ä¢ Doppelklick auf Zeilennummern (#) um Position zu √§ndern<br>‚Ä¢ Tab/Shift+Tab f√ºr Navigation zwischen Textfeldern<br>‚Ä¢ Rechtsklick f√ºr Kontext-Men√º<br>‚Ä¢ Leertaste f√ºr Audio-Wiedergabe (wenn Zeile ausgew√§hlt)',
            'levelStats.empty': 'Noch keine Level eingetragen.',
            'levelStats.empty.hint': 'Trage Level- und Teil-Informationen bei Projekten ein, um Statistiken zu sehen.',
            'levelStats.header.level': 'Level',
            'levelStats.header.parts': 'Teile',
            'levelStats.header.languages': 'EN / DE / BEIDE / ‚àë',
            'levelStats.header.completion': 'Fertig-%',
            'levelStats.table.header.level': 'Level',
            'levelStats.table.header.parts': 'Teile',
            'levelStats.table.header.languages': 'EN / DE / BEIDE / ‚àë',
            'levelStats.table.header.completion': 'Fertig-%',
            'table.header.number': '#',
            'table.header.filename': 'Dateiname',
            'table.header.folder': 'Ordner',
            'table.header.storage': 'Speicher',
            'table.header.version': 'Version\nScore',
            'table.header.text': 'EN/DE Text',
            'table.header.search': 'UT-Suche',
            'table.header.path': 'Pfad',
            'table.header.length': 'L√§nge',
            'table.header.actions': 'Aktionen',
            'status.ready': 'Bereit',
            'status.unsaved': 'Ungespeicherte √Ñnderungen',
            'status.savedKeyword': 'gespeichert',
            'status.saved.append': '(im {mode})',
            'status.files': '0 Dateien',
            'status.selected': '0 ausgew√§hlt',
            'status.folder': 'sounds',
            'status.access': 'üìÇ Keine Auswahl',
            'folderBrowser.title': 'üìÅ Ordner durchsuchen',
            'folderBrowser.back': '‚Üê Zur√ºck zur Ordner√ºbersicht',
            'folderBrowser.stats.title': 'üìä Globale √úbersetzungsstatistiken',
            'folderBrowser.stats.overall': 'Gesamt-Fortschritt',
            'folderBrowser.stats.translatedFiles': 'Dateien √ºbersetzt',
            'folderBrowser.stats.completedFolders': 'Ordner komplett',
            'folderBrowser.stats.textSummary': 'EN / DE / BEIDE / ‚àë',
            'folderBrowser.stats.hint': 'Durchsuchen Sie alle verf√ºgbaren Ordner. Gr√ºne Ordner sind vollst√§ndig √ºbersetzt.',
            'folderBrowser.cleanup.button': 'üßπ Ordnernamen bereinigen',
            'folderBrowser.cleanup.hint': 'Bereinigt falsche Ordnernamen in der Datenbank',
            'folderBrowser.missing.button': '‚ùì Fehlende Ordner',
            'folderBrowser.missing.hint': 'Listet nicht mehr existierende Ordner auf',
            'folderBrowser.empty.title': 'Automatischer Ordner-Scan',
            'folderBrowser.empty.message': 'Keine Ordner gefunden. Starte automatischen Scan...<br>Bitte w√§hlen Sie einen Ordner mit Audio-Dateien aus.',
            'folderBrowser.empty.openDialog': 'üìÅ Ordner-Dialog wird ge√∂ffnet...',
            'folderBrowser.card.files': '{count} Dateien',
            'folderBrowser.card.translatedOpen': '{done} √ºbersetzt ¬∑ {open} offen',
            'folderBrowser.card.progress': '{percent}% √ºbersetzt',
            'folderBrowser.customize.title': 'Ordner anpassen',
            'folderBrowser.delete.title': 'Ordner aus Datenbank l√∂schen',
            'folderBrowser.report': 'Bericht',
            'folderBrowser.close': 'Schlie√üen',
            'folderBrowser.report.total': 'Gesamt: {total} Dateien, {done} √ºbersetzt, {open} offen, {percent}%',
            'folderBrowser.report.line': '{folder}: {total} Dateien, {done} √ºbersetzt, {open} offen, {percent}%',
            'folderBrowser.report.copied': 'üìã Bericht kopiert',
            'folderBrowser.report.copyError': 'Bericht konnte nicht kopiert werden.',
            'folderFiles.summary': '‚úÖ {done} √ºbersetzt ‚Äì üö´ {ignored} ignoriert ‚Äì ‚è≥ {open} offen',
            'folderFiles.createProject': 'Projekt erstellen mit fehlenden Dateien',
            'folderFiles.badge.done': '√úbersetzt',
            'folderFiles.badge.ignored': 'Ignoriert',
            'folderFiles.path': 'Pfad',
            'folderFiles.noText': '(kein Text)',
            'folderFiles.added': '‚úì Bereits hinzugef√ºgt',
            'folderFiles.add': '+ Hinzuf√ºgen',
            'folderFiles.ignore': 'üö´ Ignorieren',
            'folderFiles.resume': '‚Ü© Wieder aufnehmen',
            'folderFiles.search.placeholder': 'Text im Ordner suchen...',
            'missingFolders.title': 'üö´ Fehlende Ordner',
            'missingFolders.databaseTitle': 'üìÅ Ordner in der Datenbank',
            'missingFolders.deleteAll': 'Alle l√∂schen',
            'missingFolders.close': 'Schlie√üen',
            'missingFolders.none': 'Alle Ordner existieren noch.',
            'missingFolders.databaseNone': 'Keine Ordner in der Datenbank.',
            'missingFolders.delete': 'L√∂schen',
            'folderSelection.title': 'üìÅ Ordner-Auswahl f√ºr mehrdeutige Dateien',
            'folderSelection.description': 'Die folgenden Dateien wurden in mehreren Ordnern gefunden.',
            'folderSelection.hint': 'Bitte w√§hlen Sie den passenden Ordner f√ºr jede Datei aus:',
            'folderSelection.applyToAll': 'üîÑ Erste Auswahl auf alle folgenden Dateien √ºbertragen',
            'folderSelection.applyToAllHint': 'Wenn aktiviert, wird die erste Ordner-Auswahl automatisch f√ºr alle weiteren Dateien verwendet.',
            'folderSelection.autoApplied': '‚úÖ Auto-√ºbertragen',
            'folderSelection.foundIn': 'Gefunden in {count} Ordnern:',
            'folderSelection.missingAudio': '‚ö†Ô∏è Audio nicht im Cache',
            'folderSelection.skip': '‚ùå √úberspringen',
            'folderSelection.help.title': 'üéØ Auswahlhilfen:',
            'folderSelection.help.audioAvailable': 'üéµ = Audio-Datei ist verf√ºgbar',
            'folderSelection.help.audioMissing': '‚ùì = Audio-Datei nicht im Cache',
            'folderSelection.help.autoApplied': 'üîÑ = Auswahl wurde automatisch √ºbertragen',
            'folderSelection.help.contextAdvice': 'W√§hlen Sie den Ordner, der zum Kontext des Textes passt',
            'folderSelection.help.skipAdvice': '"√úberspringen" ignoriert diese Datei beim Import',
            'folderSelection.skipAll': 'Alle √ºberspringen',
            'folderSelection.confirm': 'Auswahl best√§tigen',
            'folderSelection.applyToAllSuccess': '‚úÖ Ordner "{folder}" wurde auf alle {count} weiteren Dateien √ºbertragen.',
            'folderSelection.applyToAllSkipped': '‚ùå "√úberspringen" wurde auf alle {count} weiteren Dateien √ºbertragen.',
            'folderSelection.unselectedConfirm': '{count} Dateien haben keine Auswahl.\nDiese werden √ºbersprungen.\n\nFortfahren?',
            'context.play': 'Audio abspielen',
            'context.copyEn': 'EN Text kopieren',
            'context.copyDe': 'DE Text kopieren',
            'context.pasteEn': 'In EN Text einf√ºgen',
            'context.pasteDe': 'In DE Text einf√ºgen',
            'context.uploadDe': 'DE-Datei hochladen',
            'context.history': 'Historie',
            'context.openFolder': 'In Ordner-Browser √∂ffnen',
            'context.delete': 'Datei l√∂schen',
            'file.subtitle.searchTooltip': '√Ñhnlichen Untertitel suchen',
            'file.wordList.open': 'W√∂rterbuch √∂ffnen',
            'file.path.en': 'Pfad der EN-Datei',
            'file.path.de': 'Pfad der DE-Datei',
            'file.path.missing': 'fehlend',
            'file.length.original': 'Original',
            'file.length.edited': 'Bearbeitet',
            'deEdit.waveLabel.original': 'EN (Original)',
            'deEdit.waveLabel.originalWithSeconds': 'EN (Original) - {seconds}s',
            'deEdit.waveLabel.edited': 'DE (bearbeiten)',
            'deEdit.waveLabel.editedWithSeconds': 'DE (bearbeiten) - {seconds}s',
            'deEdit.waveInfo.enSeconds': 'EN: {seconds}s',
            'deAudio.dialog.close': 'Fenster schlie√üen',
            'deAudio.dialog.header': '‚úÇÔ∏è DE-Audio bearbeiten',
            'deAudio.dialog.reset': 'Zur√ºcksetzen',
            'deAudio.dialog.save': 'Speichern',
            'deAudio.dialog.saveClose': 'Speichern & schlie√üen',
            'deAudio.controls.zoom.label': 'Zoom',
            'deAudio.controls.zoom.out': 'Zoom verkleinern',
            'deAudio.controls.zoom.in': 'Zoom vergr√∂√üern',
            'deAudio.controls.scroll.label': 'Position',
            'deAudio.controls.scroll.left': 'Nach links springen',
            'deAudio.controls.scroll.right': 'Nach rechts springen',
            'deAudio.controls.height.label': 'H√∂he',
            'deAudio.controls.syncScroll': 'Scroll koppeln',
            'deAudio.controls.fitAll': '‚Üî Alles zeigen',
            'deAudio.controls.focusSelection': 'üéØ Auswahl',
            'deAudio.quick.header': 'Schnellzugriff',
            'deAudio.quick.subheadline': 'Die wichtigsten Schritte stehen als kompakte Buttons bereit und markieren beim Klick die passenden Detailbereiche.',
            'deAudio.quick.trim': 'Trim',
            'deAudio.quick.auto': 'Auto',
            'deAudio.quick.segment': 'Segmente',
            'deAudio.quick.tempo': 'Tempo',
            'deAudio.quick.tempoMinus': 'Tempo schrittweise verringern',
            'deAudio.quick.tempoPlus': 'Tempo schrittweise erh√∂hen',
            'deAudio.quick.tempo120': 'Tempo direkt auf 1,20 setzen',
            'deAudio.quick.tempo130': 'Tempo direkt auf 1,30 setzen',
            'deAudio.quick.volume': 'Pegel',
            'deAudio.quick.radio': 'Funk',
            'deEdit.segment.emptySuggestions': 'Noch keine Segment-Vorschl√§ge berechnet.',
            'deEdit.segment.emptyActive': 'Keine aktiven Segmente vorhanden.',
            'deEdit.segment.indexLabel': '#{position}',
            'deEdit.segment.start': 'Start: {time}',
            'deEdit.segment.end': 'Ende: {time}',
            'deEdit.segment.length': 'L√§nge: {ms} ms',
            'deEdit.segment.keep': 'Behalten',
            'deEdit.segment.drop': 'L√∂schen',
            'file.actions.de.upload': 'DE-Audio hochladen',
            'file.actions.history': 'Historie anzeigen',
            'file.actions.dubbing.start': 'Dubbing starten',
            'file.actions.dubbing.emotional': 'Emotionales Dubbing starten',
            'dubbing.status.none': 'kein Dubbing',
            'dubbing.status.pending': 'Studio generiert noch',
            'dubbing.status.done': 'fertig',
            'file.actions.dubbing.download': 'Dubbing herunterladen (ID: {id})',
            'file.actions.dubbing.downloadEmo': 'Emo-Dubbing herunterladen (ID: {id})',
            'file.actions.de.edit': 'DE-Audio bearbeiten',
            'file.actions.de.status.trimmed': 'Audio gek√ºrzt',
            'file.actions.de.status.volumeMatched': 'Lautst√§rke angepasst',
            'file.actions.de.status.volumeBoost': 'Lautst√§rke-Booster',
            'file.actions.de.status.radio': 'Funkger√§t-Effekt',
            'file.actions.de.status.hall': 'Hall-Effekt',
            'file.actions.de.status.emi': 'EM-St√∂rger√§usch',
            'file.actions.de.status.neighbor': 'Nebenraum-Effekt',
            'file.actions.de.status.tableMic': 'Telefon-auf-Tisch-Effekt',
            'file.actions.de.status.zoo': 'Zoo-Lautsprecher',
            'file.actions.de.emoDone': 'Zeile fertig vertont',
            'file.actions.row.delete': 'Zeile l√∂schen',
            'dubbing.saved.empty': 'Keine Dubbing-Parameter gespeichert',
            'dubbing.saved.none': 'Keine gespeichert',
            'dubbing.param.entry': '{label}: {value}',
            'dubbing.param.stability': 'Stabilit√§t',
            'dubbing.param.similarityBoost': 'Similarity Boost',
            'dubbing.param.style': 'Stil',
            'dubbing.param.speed': 'Geschwindigkeit',
            'dubbing.param.speakerBoost': 'Speaker-Boost',
            'dubbing.label.stability': 'Stabilit√§t',
            'dubbing.label.similarityBoost': 'Similarity Boost',
            'dubbing.label.style': 'Stil',
            'dubbing.label.speed': 'Geschwindigkeit',
            'dubbing.label.speakerBoost': 'Speaker-Boost',
            'voiceSettings.empty': 'Keine gespeicherten Voice-Einstellungen',
            'voiceSettings.label.stability': 'Stabilit√§t',
            'voiceSettings.label.similarityBoost': 'Similarity Boost',
            'voiceSettings.label.style': 'Stil',
            'voiceSettings.label.speed': 'Geschwindigkeit',
            'voiceSettings.label.speakerBoost': 'Speaker-Boost',
            'voiceSettings.value.missing': '‚Äî',
            'voiceSettings.boolean.true': 'ja',
            'voiceSettings.boolean.false': 'nein',
            'dubbing.emo.completeStatus': 'Emo-Dubbing abgeschlossen',
            'dubbing.emo.logComplete': 'Emo-Dubbing fertiggestellt.',
            'emo.error.missingGptKey': 'GPT-Key fehlt',
            'emo.generate.placeholder': '...',
            'emo.generate.button.label': 'Emotionen generieren',
            'emo.generate.button.start': 'Generiere...',
            'emo.generate.button.progress': 'Generiere... ({done}/{total})',
            'emo.generate.button.progressSingle': 'Generiere... ({current}/{total})',
            'emo.generate.status.complete': 'Fertig ({done}/{total})',
            'emo.generate.status.single': 'Emotionen generiert: {filename}',
            'emo.generate.status.error': 'Fehler bei der Generierung',
            'emo.adjust.status.single': 'Text angepasst: {filename}',
            'emo.adjust.status.error': 'Fehler bei der Anpassung',
            'emo.improve.status.single': 'Text verbessert: {filename}',
            'emo.improve.status.cancel': 'Verbesserung abgebrochen',
            'emo.improve.status.error': 'Verbesserung fehlgeschlagen',
            'emo.progress.placeholder': 'üü£ ...',
            'emo.progress.counter': 'üü£ {current}/{total}',
            'emo.progress.done': 'üü£ fertig',
            'emo.status.updated': 'Emotional-Texte aktualisiert ({count})',
            'auto.trans.line': '√úbersetzung f√ºr diese Zeile',
            'auto.trans.all': '√úbersetzung f√ºr alle Zeilen',
            'project.menu.edit': 'Projekt bearbeiten',
            'project.menu.analyze': 'Projekt analysieren',
            'project.menu.delete': 'Projekt l√∂schen',
            'loading.scan': 'Scanne Dateien...',
            'loading.translate': '√úbersetze...',
            'loading.subtitle': 'Suche Untertitel...',
            'meta.level': '| Level:',
            'meta.part': '| Teil:',
            'language.label': 'Sprache',
            'language.german': 'Deutsch',
            'language.english': 'Englisch',
            'project.tooltip.level': 'Level: {level}',
            'project.tooltip.part': 'Teil: {part}',
            'project.tooltip.label.level': 'Level',
            'project.tooltip.label.part': 'Teil',
            'project.tooltip.label.en': 'EN',
            'project.tooltip.label.de': 'DE',
            'project.tooltip.label.deAudio': 'DE-Audio',
            'project.tooltip.label.complete': 'Fertig',
            'project.tooltip.label.gpt': 'GPT',
            'project.tooltip.label.files': 'Dateien',
            'project.tooltip.line.progress': '‚Ä¢ EN: {enPercent}%  ‚Ä¢ DE: {dePercent}%',
            'project.tooltip.line.audio': '‚Ä¢ DE-Audio: {deAudioPercent}%  ‚Ä¢ Fertig: {completedPercent}%{done}',
            'project.tooltip.line.gptFiles': '‚Ä¢ GPT: {score}  ‚Ä¢ Dateien: {files}',
            'project.tooltip.done': ' ‚úÖ',
            'import.title': 'üì• Daten importieren',
            'import.description': 'Unterst√ºtzte Formate:<br>‚Ä¢ Wiki-Tabelle (automatische Spalten-Erkennung)<br>‚Ä¢ Pipe-Liste: <code>Dateiname|EN Text|DE Text</code><br>‚Ä¢ Der Import erkennt automatisch, welche Spalte die Dateinamen enth√§lt',
            'import.file.button': 'üìÇ Datei ausw√§hlen',
            'import.file.none': 'Keine Datei ausgew√§hlt',
            'import.file.loading': 'Lade {name}...',
            'import.file.loaded': '{name} ({length} Zeichen)',
            'import.data.placeholder': 'F√ºge hier deine Daten ein...',
            'import.columns.title': 'üìã Spalten-Zuordnung',
            'import.columns.description': 'Bitte w√§hlen Sie aus, welche Spalten welche Inhalte enthalten:',
            'import.columns.filename': 'Dateinamen-Spalte:',
            'import.columns.hint': 'üí° Intelligente Erkennung basierend auf Datenbank und Patterns',
            'import.columns.english': 'Englischer Text-Spalte:',
            'import.columns.german': 'Deutsche Text-Spalte (optional):',
            'import.columns.selectPrompt': '-- Bitte ausw√§hlen --',
            'import.columns.noneOption': '-- Keine / Nicht vorhanden --',
            'import.preview.title': 'üîç Vorschau (erste 3 Zeilen):',
            'import.preview.columnLabel': 'Spalte {index}',
            'import.preview.filename': '(Dateinamen)',
            'import.preview.english': '(EN Text)',
            'import.preview.german': '(DE Text)',
            'import.confidence.veryHigh': '‚úÖ (sehr sicher)',
            'import.confidence.high': '‚úÖ (sicher)',
            'import.confidence.low': '‚ö†Ô∏è (unsicher)',
            'import.confidence.guess': '‚ùì (geraten)',
            'import.error.noData': 'Bitte f√ºgen Sie erst Daten ein!',
            'import.error.noValidData': 'Keine g√ºltigen Daten gefunden!\n\nUnterst√ºtzte Formate:\n‚Ä¢ Wiki-Tabelle\n‚Ä¢ Pipe-Format (Datei|Text|Text)',
            'import.error.analysis': 'Fehler beim Analysieren der Daten:',
            'import.error.read': 'Fehler beim Lesen der Datei. Bitte erneut versuchen.',
            'import.error.label': 'Fehler beim Laden der Datei',
            'import.error.noFilenameColumn': 'Keine Dateinamen-Spalte gefunden!\n\nDateinamen sollten erkennbar sein als:\n‚Ä¢ Code-Tags: <code>dateiname</code>\n‚Ä¢ Dateinamen mit Zahlen: 02_01103\n‚Ä¢ Dateinamen mit Erweiterung: datei.mp3',
            'import.status.fileLoaded': 'Datei "{name}" geladen',
            'import.status.analysis': 'Daten analysiert -',
            'import.status.confidenceHigh': 'Hohe Konfidenz bei Dateinamen-Erkennung',
            'import.status.confidenceLow': 'Niedrige Konfidenz - bitte Auswahl pr√ºfen',
            'import.buttons.cancel': 'Abbrechen',
            'import.buttons.analyze': 'Analysieren',
            'import.buttons.start': 'Import starten'
        },
        en: {
            'app.title': 'Half-Life: Alyx Translation Tool',
            'loading.project': 'Loading project...',
            'loading.retry': 'Retry',
            'sidebar.projects': 'üéÆ Projects',
            'project.add': '+ New Project',
            'tab.project': 'Project',
            'tab.tools': 'Tools',
            'tab.media': 'Media',
            'tab.system': 'System',
            'tab.search': 'Search & History',
            'toolbar.project.title': 'Project',
            'toolbar.tools.title': 'Tools',
            'toolbar.media.title': 'Media',
            'toolbar.system.title': 'System',
            'toolbar.search.title': 'Search & History',
            'button.import': 'üì• Import',
            'button.ccImport': 'üé¨ Subtitles',
            'button.folder': 'üìÅ Folder',
            'label.addFiles': 'Add files',
            'placeholder.addFiles': 'Enter filenames (one per line)...',
            'button.addFiles': 'Add',
            'button.gptScore': 'Score (GPT)',
            'button.randomProject': 'üé≤ Random',
            'button.wordList': 'üìö Words',
            'button.generateEmotions': 'Emotions (DE)',
            'button.sendElevenLabs': 'Send to ElevenLabs',
            'button.assignAudio': 'üîä Assign audio file',
            'button.importZip': 'Import ZIP',
            'button.copyAssistant': 'Copy helper',
            'button.copyAssistant2': 'Copy helper 2',
            // Copy assistant translations with placeholders
            'copyAssistant.status.complete': 'Copy helper completed',
            'copyAssistant.progress.files': 'File {current} of {total}',
            'copyAssistant.progress.steps': 'Step {current} of {total}',
            'button.copyEmotions': 'Copy emotions',
            'button.subtitleSearchAll': 'Subtitle search all',
            'button.dubbingLog': 'üìù Log',
            'button.devTools': 'üêû DevTools',
            'button.debugReport': 'üìã Debug report',
            'settings.title': '‚öôÔ∏è Settings',
            'settings.cleanupDuplicates': 'üßπ Remove duplicates',
            'settings.audioDuplicates': 'üéµ Audio duplicates',
            'settings.backup': 'üíæ Backup',
            'settings.elevenLabs': 'üîä ElevenLabs API',
            'settings.gpt': 'üí¨ ChatGPT API',
            'settings.resetDb': 'üîÑ Reset DB',
            'settings.cleanupProjects': 'üîÑ Clean projects',
            'settings.repairFolders': 'üîß Repair folders',
            'settings.language': 'üåê Language',
            'toolbar.media.videos': 'üé¨ Videos',
            'label.mode': 'Game',
            'label.workshop': 'Workshop',
            'label.mapToggle': '+map',
            'placeholder.level': 'Level',
            'button.start': 'Start',
            'option.godmode': 'Godmode',
            'option.ammo': 'Infinite ammo',
            'option.console': 'Developer console',
            'system.menu': 'Administration',
            'system.migration.title': 'Migration',
            'system.migration.start': 'Start migration',
            'system.migration.load': 'Load migration',
            'system.migration.process': 'Migrate data',
            'system.storage.title': 'Storage',
            'system.storage.switch': 'Switch',
            'system.storage.folder': 'üìÇ Storage folder',
            'system.storage.cleanup': 'Clean up',
            'storage.dialog.title': 'Choose storage mode',
            'storage.dialog.description': 'Please select a storage system:',
            'storage.dialog.local': 'LocalStorage',
            'storage.dialog.indexed': 'New system',
            'storage.mode.local': 'LocalStorage',
            'storage.mode.file': 'File mode',
            'storage.mode.fileOpfs': 'File mode (OPFS)',
            'storage.mode.fileBase64': 'File mode (Base64)',
            'storage.switch.toLocal': 'Switch to LocalStorage',
            'storage.switch.toFile': 'Switch to file mode',
            'storage.switch.loading': 'Loading {mode}...',
            'storage.switch.toast': 'Switching to {mode} (without copying data)',
            'storage.switch.loaded': '{mode} loaded',
            'storage.switch.now': 'Now using {mode}',
            'storage.persist.denied': 'Persistent storage was not granted',
            'storage.persist.granted': 'Local storage secured, available: {free} MB',
            'storage.visualize.indexedOnly': '‚Äú{key}‚Äù lives in the new storage system.',
            'storage.visualize.localOnly': '‚Äú{key}‚Äù is still in LocalStorage.',
            'storage.visualize.both': '‚Äú{key}‚Äù exists in both storage systems.',
            'storage.visualize.none': '‚Äú{key}‚Äù was not found in any storage system.',
            'storage.folder.unavailable': 'Path to the new storage system is unavailable',
            'storage.usage.label': '{used} MB of {quota} MB',
            'storage.cleanup.last': 'Last cleaned on {date}',
            'storage.cleanup.never': 'Never cleaned',
            'storage.cleanup.toast': 'Storage cleaned',
            'search.placeholder': 'Live search: filename or text... (case-insensitive, dots ignored)',
            'search.copy.remainder': 'Remainder mode',
            'search.copy.time': 'Prefix time',
            'search.copy.dashes': 'Append ---',
            'search.copy.speed': 'Add ‚Äúextremely fast speech‚Äù',
            'search.sort': 'Sort:',
            'search.sort.position': 'Position',
            'search.sort.filename': 'Filename',
            'search.sort.folder': 'Folder',
            'search.sort.completion': 'Done',
            'progress.total': '0% complete',
            'progress.folders': '0 folders',
            'progress.global': '0% overall',
            'empty.title': 'No files in project',
            'empty.hint': 'Add files via search or the input field.',
            'empty.tips': 'üí° Tips:<br>‚Ä¢ Double-click row numbers (#) to change position<br>‚Ä¢ Tab/Shift+Tab to navigate between fields<br>‚Ä¢ Right-click for context menu<br>‚Ä¢ Spacebar for audio playback (when a row is selected)',
            'levelStats.empty': 'No levels added yet.',
            'levelStats.empty.hint': 'Add level and part details to your projects to see statistics.',
            'levelStats.header.level': 'Level',
            'levelStats.header.parts': 'Parts',
            'levelStats.header.languages': 'EN / DE / BOTH / ‚àë',
            'levelStats.header.completion': 'Done-%',
            'levelStats.table.header.level': 'Level',
            'levelStats.table.header.parts': 'Parts',
            'levelStats.table.header.languages': 'EN / DE / BOTH / ‚àë',
            'levelStats.table.header.completion': 'Done-%',
            'table.header.number': '#',
            'table.header.filename': 'Filename',
            'table.header.folder': 'Folder',
            'table.header.storage': 'Storage',
            'table.header.version': 'Version\nScore',
            'table.header.text': 'EN/DE text',
            'table.header.search': 'Subtitle search',
            'table.header.path': 'Path',
            'table.header.length': 'Length',
            'table.header.actions': 'Actions',
            'status.ready': 'Ready',
            'status.unsaved': 'Unsaved changes',
            'status.savedKeyword': 'saved',
            'status.saved.append': '(in {mode})',
            'status.files': '0 files',
            'status.selected': '0 selected',
            'status.folder': 'sounds',
            'status.access': 'üìÇ No selection',
            'folderBrowser.title': 'üìÅ Browse folders',
            'folderBrowser.back': '‚Üê Back to folder overview',
            'folderBrowser.stats.title': 'üìä Global translation stats',
            'folderBrowser.stats.overall': 'Overall progress',
            'folderBrowser.stats.translatedFiles': 'Files translated',
            'folderBrowser.stats.completedFolders': 'Folders complete',
            'folderBrowser.stats.textSummary': 'EN / DE / BOTH / ‚àë',
            'folderBrowser.stats.hint': 'Browse all available folders. Green folders are fully translated.',
            'folderBrowser.cleanup.button': 'üßπ Clean folder names',
            'folderBrowser.cleanup.hint': 'Cleans incorrect folder names in the database',
            'folderBrowser.missing.button': '‚ùì Missing folders',
            'folderBrowser.missing.hint': 'Lists folders that no longer exist',
            'folderBrowser.empty.title': 'Automatic folder scan',
            'folderBrowser.empty.message': 'No folders found. Starting automatic scan...<br>Please select a folder with audio files.',
            'folderBrowser.empty.openDialog': 'üìÅ Opening folder dialog...',
            'folderBrowser.card.files': '{count} files',
            'folderBrowser.card.translatedOpen': '{done} translated ¬∑ {open} open',
            'folderBrowser.card.progress': '{percent}% translated',
            'folderBrowser.customize.title': 'Customize folder',
            'folderBrowser.delete.title': 'Remove folder from database',
            'folderBrowser.report': 'Report',
            'folderBrowser.close': 'Close',
            'folderBrowser.report.total': 'Total: {total} files, {done} translated, {open} open, {percent}%',
            'folderBrowser.report.line': '{folder}: {total} files, {done} translated, {open} open, {percent}%',
            'folderBrowser.report.copied': 'üìã Report copied',
            'folderBrowser.report.copyError': 'Report could not be copied.',
            'folderFiles.summary': '‚úÖ {done} translated ‚Äì üö´ {ignored} ignored ‚Äì ‚è≥ {open} open',
            'folderFiles.createProject': 'Create project with missing files',
            'folderFiles.badge.done': 'Translated',
            'folderFiles.badge.ignored': 'Ignored',
            'folderFiles.path': 'Path',
            'folderFiles.noText': '(no text)',
            'folderFiles.added': '‚úì Already added',
            'folderFiles.add': '+ Add',
            'folderFiles.ignore': 'üö´ Ignore',
            'folderFiles.resume': '‚Ü© Re-enable',
            'folderFiles.search.placeholder': 'Search text inside this folder...',
            'missingFolders.title': 'üö´ Missing folders',
            'missingFolders.databaseTitle': 'üìÅ Folders in the database',
            'missingFolders.deleteAll': 'Delete all',
            'missingFolders.close': 'Close',
            'missingFolders.none': 'All folders still exist.',
            'missingFolders.databaseNone': 'No folders in the database.',
            'missingFolders.delete': 'Delete',
            'folderSelection.title': 'üìÅ Folder selection for ambiguous files',
            'folderSelection.description': 'The following files were found in multiple folders.',
            'folderSelection.hint': 'Please choose the correct folder for each file:',
            'folderSelection.applyToAll': 'üîÑ Apply first selection to all following files',
            'folderSelection.applyToAllHint': 'If enabled, the first folder selection is automatically used for all remaining files.',
            'folderSelection.autoApplied': '‚úÖ Auto-applied',
            'folderSelection.foundIn': 'Found in {count} folders:',
            'folderSelection.missingAudio': '‚ö†Ô∏è Audio not in cache',
            'folderSelection.skip': '‚ùå Skip',
            'folderSelection.help.title': 'üéØ Selection aids:',
            'folderSelection.help.audioAvailable': 'üéµ = Audio file available',
            'folderSelection.help.audioMissing': '‚ùì = Audio file not in cache',
            'folderSelection.help.autoApplied': 'üîÑ = Selection was applied automatically',
            'folderSelection.help.contextAdvice': 'Choose the folder that matches the text context',
            'folderSelection.help.skipAdvice': '"Skip" ignores this file during import',
            'folderSelection.skipAll': 'Skip all',
            'folderSelection.confirm': 'Confirm selection',
            'folderSelection.applyToAllSuccess': '‚úÖ Folder "{folder}" was applied to the remaining {count} files.',
            'folderSelection.applyToAllSkipped': '‚ùå "Skip" was applied to the remaining {count} files.',
            'folderSelection.unselectedConfirm': '{count} files have no selection.\nThey will be skipped.\n\nContinue?',
            'context.play': 'Play audio',
            'context.copyEn': 'Copy EN text',
            'context.copyDe': 'Copy DE text',
            'context.pasteEn': 'Paste into EN text',
            'context.pasteDe': 'Paste into DE text',
            'context.uploadDe': 'Upload DE file',
            'context.history': 'History',
            'context.openFolder': 'Open in folder browser',
            'context.delete': 'Delete file',
            'file.subtitle.searchTooltip': 'Search similar subtitle',
            'file.wordList.open': 'Open dictionary',
            'file.path.en': 'Path to EN file',
            'file.path.de': 'Path to DE file',
            'file.path.missing': 'missing',
            'file.length.original': 'Original',
            'file.length.edited': 'Edited',
            'deEdit.waveLabel.original': 'EN (original)',
            'deEdit.waveLabel.originalWithSeconds': 'EN (original) - {seconds}s',
            'deEdit.waveLabel.edited': 'DE (editing)',
            'deEdit.waveLabel.editedWithSeconds': 'DE (editing) - {seconds}s',
            'deEdit.waveInfo.enSeconds': 'EN: {seconds}s',
            'deAudio.dialog.close': 'Fenster schlie√üen',
            'deAudio.dialog.header': '‚úÇÔ∏è DE-Audio bearbeiten',
            'deAudio.dialog.reset': 'Zur√ºcksetzen',
            'deAudio.dialog.save': 'Speichern',
            'deAudio.dialog.saveClose': 'Speichern & schlie√üen',
            'deAudio.controls.zoom.label': 'Zoom',
            'deAudio.controls.zoom.out': 'Zoom verkleinern',
            'deAudio.controls.zoom.in': 'Zoom vergr√∂√üern',
            'deAudio.controls.scroll.label': 'Position',
            'deAudio.controls.scroll.left': 'Nach links springen',
            'deAudio.controls.scroll.right': 'Nach rechts springen',
            'deAudio.controls.height.label': 'H√∂he',
            'deAudio.controls.syncScroll': 'Scroll koppeln',
            'deAudio.controls.fitAll': '‚Üî Alles zeigen',
            'deAudio.controls.focusSelection': 'üéØ Auswahl',
            'deAudio.quick.header': 'Schnellzugriff',
            'deAudio.quick.subheadline': 'Die wichtigsten Schritte stehen als kompakte Buttons bereit und markieren beim Klick die passenden Detailbereiche.',
            'deAudio.quick.trim': 'Trim',
            'deAudio.quick.auto': 'Auto',
            'deAudio.quick.segment': 'Segmente',
            'deAudio.quick.tempo': 'Tempo',
            'deAudio.quick.tempoMinus': 'Tempo schrittweise verringern',
            'deAudio.quick.tempoPlus': 'Tempo schrittweise erh√∂hen',
            'deAudio.quick.tempo120': 'Tempo direkt auf 1,20 setzen',
            'deAudio.quick.tempo130': 'Tempo direkt auf 1,30 setzen',
            'deAudio.quick.volume': 'Pegel',
            'deAudio.quick.radio': 'Funk',
            'deEdit.segment.emptySuggestions': 'No segment suggestions calculated yet.',
            'deEdit.segment.emptyActive': 'No active segments available.',
            'deEdit.segment.indexLabel': '#{position}',
            'deEdit.segment.start': 'Start: {time}',
            'deEdit.segment.end': 'End: {time}',
            'deEdit.segment.length': 'Length: {ms} ms',
            'deEdit.segment.keep': 'Keep',
            'deEdit.segment.drop': 'Delete',
            'file.actions.de.upload': 'Upload DE audio',
            'file.actions.history': 'Show history',
            'file.actions.dubbing.start': 'Start dubbing',
            'file.actions.dubbing.emotional': 'Start emotional dubbing',
            'dubbing.status.none': 'no dubbing',
            'dubbing.status.pending': 'Studio still generating',
            'dubbing.status.done': 'done',
            'file.actions.dubbing.download': 'Download dubbing (ID: {id})',
            'file.actions.dubbing.downloadEmo': 'Download emo dubbing (ID: {id})',
            'file.actions.de.edit': 'Edit DE audio',
            'file.actions.de.status.trimmed': 'Audio trimmed',
            'file.actions.de.status.volumeMatched': 'Volume matched',
            'file.actions.de.status.volumeBoost': 'Volume boost',
            'file.actions.de.status.radio': 'Radio effect',
            'file.actions.de.status.hall': 'Reverb effect',
            'file.actions.de.status.emi': 'EM noise',
            'file.actions.de.status.neighbor': 'Next-room effect',
            'file.actions.de.status.tableMic': 'Phone-on-table effect',
            'file.actions.de.status.zoo': 'Zoo speaker',
            'file.actions.de.emoDone': 'Line voiced',
            'file.actions.row.delete': 'Delete line',
            'dubbing.saved.empty': 'No dubbing parameters stored yet',
            'dubbing.saved.none': 'None saved',
            'dubbing.param.entry': '{label}: {value}',
            'dubbing.param.stability': 'Stability',
            'dubbing.param.similarityBoost': 'Similarity Boost',
            'dubbing.param.style': 'Style',
            'dubbing.param.speed': 'Speed',
            'dubbing.param.speakerBoost': 'Speaker boost',
            'dubbing.label.stability': 'Stability',
            'dubbing.label.similarityBoost': 'Similarity Boost',
            'dubbing.label.style': 'Style',
            'dubbing.label.speed': 'Speed',
            'dubbing.label.speakerBoost': 'Speaker boost',
            'voiceSettings.empty': 'No saved voice settings',
            'voiceSettings.label.stability': 'Stability',
            'voiceSettings.label.similarityBoost': 'Similarity Boost',
            'voiceSettings.label.style': 'Style',
            'voiceSettings.label.speed': 'Speed',
            'voiceSettings.label.speakerBoost': 'Speaker boost',
            'voiceSettings.value.missing': '‚Äî',
            'voiceSettings.boolean.true': 'yes',
            'voiceSettings.boolean.false': 'no',
            'dubbing.emo.completeStatus': 'Emo dubbing complete',
            'dubbing.emo.logComplete': 'Emo dubbing finished.',
            'emo.error.missingGptKey': 'GPT key missing',
            'emo.generate.placeholder': '...',
            'emo.generate.button.label': 'Generate emotions',
            'emo.generate.button.start': 'Generating...',
            'emo.generate.button.progress': 'Generating... ({done}/{total})',
            'emo.generate.button.progressSingle': 'Generating... ({current}/{total})',
            'emo.generate.status.complete': 'Done ({done}/{total})',
            'emo.generate.status.single': 'Emotions generated: {filename}',
            'emo.generate.status.error': 'Error during generation',
            'emo.adjust.status.single': 'Text adjusted: {filename}',
            'emo.adjust.status.error': 'Adjustment failed',
            'emo.improve.status.single': 'Text improved: {filename}',
            'emo.improve.status.cancel': 'Improvement canceled',
            'emo.improve.status.error': 'Improvement failed',
            'emo.progress.placeholder': 'üü£ ...',
            'emo.progress.counter': 'üü£ {current}/{total}',
            'emo.progress.done': 'üü£ done',
            'emo.status.updated': 'Emotional texts updated ({count})',
            'auto.trans.line': 'Translate this line',
            'auto.trans.all': 'Translate all lines',
            'project.menu.edit': 'Edit project',
            'project.menu.analyze': 'Analyze project',
            'project.menu.delete': 'Delete project',
            'loading.scan': 'Scanning files...',
            'loading.translate': 'Translating...',
            'loading.subtitle': 'Searching subtitles...',
            'meta.level': '| Level:',
            'meta.part': '| Part:',
            'language.label': 'Language',
            'language.german': 'German',
            'language.english': 'English',
            'project.tooltip.level': 'Level: {level}',
            'project.tooltip.part': 'Part: {part}',
            'project.tooltip.label.level': 'Level',
            'project.tooltip.label.part': 'Part',
            'project.tooltip.label.en': 'EN',
            'project.tooltip.label.de': 'DE',
            'project.tooltip.label.deAudio': 'DE audio',
            'project.tooltip.label.complete': 'Done',
            'project.tooltip.label.gpt': 'GPT',
            'project.tooltip.label.files': 'Files',
            'project.tooltip.line.progress': '‚Ä¢ EN: {enPercent}%  ‚Ä¢ DE: {dePercent}%',
            'project.tooltip.line.audio': '‚Ä¢ DE audio: {deAudioPercent}%  ‚Ä¢ Done: {completedPercent}%{done}',
            'project.tooltip.line.gptFiles': '‚Ä¢ GPT: {score}  ‚Ä¢ Files: {files}',
            'project.tooltip.done': ' ‚úÖ',
            'import.title': 'üì• Import data',
            'import.description': 'Supported formats:<br>‚Ä¢ Wiki table (automatic column detection)<br>‚Ä¢ Pipe list: <code>Filename|EN Text|DE Text</code><br>‚Ä¢ Import automatically detects which column contains the filenames',
            'import.file.button': 'üìÇ Choose file',
            'import.file.none': 'No file selected',
            'import.file.loading': 'Loading {name}...',
            'import.file.loaded': '{name} ({length} characters)',
            'import.data.placeholder': 'Paste your data here...',
            'import.columns.title': 'üìã Column mapping',
            'import.columns.description': 'Please choose which columns contain which content:',
            'import.columns.filename': 'Filename column:',
            'import.columns.hint': 'üí° Smart detection based on database and patterns',
            'import.columns.english': 'English text column:',
            'import.columns.german': 'German text column (optional):',
            'import.columns.selectPrompt': '-- Please choose --',
            'import.columns.noneOption': '-- None / Not available --',
            'import.preview.title': 'üîç Preview (first 3 rows):',
            'import.preview.columnLabel': 'Column {index}',
            'import.preview.filename': '(Filenames)',
            'import.preview.english': '(EN text)',
            'import.preview.german': '(DE text)',
            'import.confidence.veryHigh': '‚úÖ (very confident)',
            'import.confidence.high': '‚úÖ (confident)',
            'import.confidence.low': '‚ö†Ô∏è (uncertain)',
            'import.confidence.guess': '‚ùì (guessed)',
            'import.error.noData': 'Please insert data first!',
            'import.error.noValidData': 'No valid data found!\n\nSupported formats:\n‚Ä¢ Wiki table\n‚Ä¢ Pipe format (file|text|text)',
            'import.error.analysis': 'Error while analyzing data:',
            'import.error.read': 'Error reading file. Please try again.',
            'import.error.label': 'Error loading file',
            'import.error.noFilenameColumn': 'No filename column found!\n\nFilenames should be recognizable as:\n‚Ä¢ Code tags: <code>filename</code>\n‚Ä¢ Filenames with numbers: 02_01103\n‚Ä¢ Filenames with extension: file.mp3',
            'import.status.fileLoaded': 'File "{name}" loaded',
            'import.status.analysis': 'Data analyzed -',
            'import.status.confidenceHigh': 'High confidence for filename detection',
            'import.status.confidenceLow': 'Low confidence - please verify selection',
            'import.buttons.cancel': 'Cancel',
            'import.buttons.analyze': 'Analyze',
            'import.buttons.start': 'Start import'
        }
    };

    const defaultLanguage = 'de';
    const registeredTargets = [];
    const listeners = [];
    let currentLanguage = defaultLanguage;

    function getActiveStorage() {
        return window.storage || window.localStorage;
    }

    function getStoredLanguage() {
        const storage = getActiveStorage();
        const stored = storage && storage.getItem('hla_language');
        return stored && resources[stored] ? stored : null;
    }

    function persistLanguage(lang) {
        const storage = getActiveStorage();
        try {
            storage && storage.setItem('hla_language', lang);
        } catch (err) {
            console.warn('Konnte Sprache nicht speichern:', err);
        }
    }

    function t(key) {
        const langPack = resources[currentLanguage] || resources[defaultLanguage];
        if (langPack && Object.prototype.hasOwnProperty.call(langPack, key)) {
            return langPack[key];
        }
        const fallbackPack = resources[defaultLanguage];
        if (fallbackPack && Object.prototype.hasOwnProperty.call(fallbackPack, key)) {
            return fallbackPack[key];
        }
        return key;
    }

    function applyTargets() {
        registeredTargets.forEach(entry => {
            const el = typeof entry.selector === 'string'
                ? document.querySelector(entry.selector)
                : entry.element;
            if (!el) return;
            const value = t(entry.key);
            if (entry.attribute) {
                el.setAttribute(entry.attribute, value);
            } else if (entry.html) {
                el.innerHTML = value;
            } else {
                el.textContent = value;
            }
        });
    }

    // Ersetzt Platzhalter in √úbersetzungen, z.B. {current} oder {total}
    function format(key, replacements = {}) {
        const template = t(key);
        return Object.entries(replacements).reduce((acc, [placeholder, value]) => {
            return acc.replaceAll(`{${placeholder}}`, value);
        }, template);
    }

    function setLanguage(lang) {
        const nextLang = resources[lang] ? lang : defaultLanguage;
        currentLanguage = nextLang;
        persistLanguage(nextLang);
        document.documentElement.lang = nextLang === 'en' ? 'en' : 'de';
        applyTargets();
        listeners.forEach(fn => fn(nextLang));
    }

    function getLanguage() {
        return currentLanguage;
    }

    function initializeLanguage() {
        const stored = getStoredLanguage();
        setLanguage(stored || defaultLanguage);
    }

    function onLanguageChange(fn) {
        listeners.push(fn);
    }

    function registerTranslationTargets(targets) {
        if (Array.isArray(targets)) {
            registeredTargets.push(...targets);
            applyTargets();
        }
    }

    window.i18n = {
        t,
        setLanguage,
        getLanguage,
        format,
        registerTranslationTargets,
        onLanguageChange,
        initializeLanguage
    };
})();
