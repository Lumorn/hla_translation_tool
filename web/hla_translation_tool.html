<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Half-Life: Alyx Translation Tool</title>
    <!-- Sicherheitsrichtlinie für Electron: verhindert Warnhinweise -->
    <!-- Aktualisierte CSP: Inline-Styles sind über style-src-attr erlaubt -->
    <!-- Medien-Blobs werden über media-src zugelassen -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' https://www.youtube.com 'unsafe-inline';
                   style-src-elem 'self';
                   style-src-attr 'self' 'unsafe-inline';
                   connect-src 'self' https://api.elevenlabs.io https://api.openai.com https://www.youtube.com https://i.ytimg.com;
                   frame-src https://www.youtube.com blob:;
                   img-src 'self' data: https://i.ytimg.com;
                   worker-src 'self' blob:;
                   media-src 'self' blob:;">
    <!-- Für oEmbed-Anfragen an YouTube -->
    <link rel="stylesheet" href="src/style.css">
</head>
<body>
    <!-- Globaler Ladebalken für Projektwechsel -->
    <div id="projectLoadingOverlay" class="loading-overlay hidden">
        <div class="loading-box">
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <span id="projectLoadingText">Projekt wird geladen...</span>
        </div>
    </div>
    <div id="errorBanner" class="error-banner hidden">
        <span id="errorBannerMessage"></span>
        <button id="errorBannerRetry">Erneut versuchen</button>
    </div>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>🎮 Projekte</h2>
            </div>
            <div class="project-list" id="projectList"></div>
            <button class="add-project-btn" onclick="addProject()">+ Neues Projekt</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="workspace-header">
                <div class="workspace-toolbar">
                    <section class="toolbar-group toolbar-group--project" aria-labelledby="toolbarProjectTitle">
                        <div class="group-main">
                            <h3 id="toolbarProjectTitle" class="group-title">Projekt</h3>
                            <div class="group-buttons">
                                <button class="btn btn-secondary" onclick="showImportDialog()">📥 Import</button>
                                <button class="btn btn-secondary" onclick="showCcImportDialog()">🎬 Untertitel</button>
                                <button class="btn btn-secondary" onclick="showFolderBrowser()">📁 Ordner</button>
                            </div>
                        </div>
                        <div class="group-body">
                            <label for="fileInput" class="group-label">Dateien hinzufügen</label>
                            <div class="project-inline">
                                <textarea class="file-input" placeholder="Dateinamen eingeben (einer pro Zeile)..." id="fileInput" rows="1"></textarea>
                                <button class="btn btn-primary" onclick="addFiles()">Hinzufügen</button>
                            </div>
                        </div>
                    </section>
                    <section class="toolbar-group toolbar-group--tools" aria-labelledby="toolbarToolsTitle">
                        <div class="group-main">
                            <h3 id="toolbarToolsTitle" class="group-title">Werkzeuge</h3>
                            <div class="group-buttons">
                                <button id="gptScoreButton" class="btn btn-secondary">Bewerten (GPT)</button>
                                <button id="randomProjectButton" class="btn btn-secondary">🎲 Zufall</button>
                                <button id="wordListButton" class="btn btn-secondary" onclick="openWordList()">📚 Wörter</button>
                                <button id="generateEmotionsButton" class="btn btn-blue" title="Erzeugt deutsche Emotionstags für alle Zeilen">Emotionen (DE)</button>
                                <button id="sendTextV2Button" class="btn btn-blue" title="Alle Emotional-Texte an ElevenLabs senden">An ElevenLabs schicken</button>
                                <div class="menu-wrapper">
                                    <button id="toolOverflowToggle" class="btn btn-secondary menu-toggle" data-menu-toggle="toolOverflowMenu" aria-haspopup="true" aria-expanded="false">⋯</button>
                                    <div class="workspace-dropdown" id="toolOverflowMenu" role="menu">
                                        <button class="dropdown-item" onclick="openSegmentDialog()">🔊 Audio-Datei zuordnen</button>
                                        <button class="dropdown-item" onclick="showZipImportDialog()">ZIP importieren</button>
                                        <button class="dropdown-item" id="copyAssistantButton">Kopierhilfe</button>
                                        <button class="dropdown-item" id="copyAssistant2Button">Kopierhilfe 2</button>
                                        <button class="dropdown-item" id="copyAllEmosButton">Emotionen kopieren</button>
                                        <button class="dropdown-item" id="subtitleSearchAllButton" title="Sucht fehlende deutsche Texte im gesamten Projekt">UT-Suche alles</button>
                                        <button class="dropdown-item" onclick="openDubbingLog()">📝 Protokoll</button>
                                        <button class="dropdown-item" id="devToolsButton">🐞 DevTools</button>
                                        <button class="dropdown-item" id="debugReportButton">📋 Debug-Bericht</button>
                                    </div>
                                </div>
                                <div class="menu-wrapper settings-container">
                                    <button id="settingsButton" class="btn btn-secondary menu-toggle" onclick="toggleSettingsMenu()" aria-haspopup="true" aria-expanded="false">⚙️ Einstellungen</button>
                                    <div class="settings-menu workspace-dropdown" id="settingsMenu" role="menu">
                                        <div class="settings-item" onclick="cleanupDuplicates()">🧹 Duplikate bereinigen</div>
                                        <div class="settings-item" onclick="scanAudioDuplicates()">🎵 Audio-Duplikate</div>
                                        <div class="settings-item" onclick="showBackupDialog()">💾 Backup</div>
                                        <div class="settings-item" onclick="showApiDialog()">🔊 ElevenLabs API</div>
                                        <div class="settings-item" onclick="showGptApiDialog()">💬 ChatGPT API</div>
                                        <div class="settings-item" onclick="resetFileDatabase()">🔄 Reset DB</div>
                                        <div class="settings-item" onclick="updateAllFilePaths()">🔄 Projekte bereinigen</div>
                                        <div class="settings-item" onclick="repairProjectFolders()">🔧 Ordner reparieren</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="toolbar-group toolbar-group--media" aria-labelledby="toolbarMediaTitle">
                        <div class="group-main">
                            <h3 id="toolbarMediaTitle" class="group-title">Medien</h3>
                            <div class="group-buttons">
                                <button id="openVideoManager" class="btn btn-secondary">🎬 Videos</button>
                            </div>
                        </div>
                        <div class="group-body">
                            <div class="hla-launch">
                                <select id="modusSelect">
                                    <option value="normal">Spiel</option>
                                    <option value="workshop">Workshop</option>
                                </select>
                                <select id="spracheSelect">
                                    <option value="english">english</option>
                                    <option value="german">german</option>
                                </select>
                                <label class="hla-launch__option">
                                    <input type="checkbox" id="mapCheckbox"> +map
                                </label>
                                <input type="text" id="mapSelect" placeholder="Level">
                                <div class="start-dropdown">
                                    <button id="startButton" class="btn btn-secondary" onclick="startHla()" title="">Starten</button>
                                    <button id="startDropdown" class="btn btn-secondary" onclick="toggleStartMenu()">▼</button>
                                    <div id="startMenu" class="dropdown-menu">
                                        <label class="dropdown-item"><input type="checkbox" id="optGod"> Godmode</label>
                                        <label class="dropdown-item"><input type="checkbox" id="optAmmo"> Unendliche Munition</label>
                                        <label class="dropdown-item"><input type="checkbox" id="optConsole"> Entwicklerkonsole</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="toolbar-group toolbar-group--system" aria-labelledby="toolbarSystemTitle">
                        <div class="group-main">
                            <h3 id="toolbarSystemTitle" class="group-title">System</h3>
                            <div class="group-buttons">
                                <div class="menu-wrapper">
                                    <button id="systemMenuToggle" class="btn btn-secondary menu-toggle" data-menu-toggle="systemMenu" aria-haspopup="true" aria-expanded="false">Verwaltung</button>
                                    <div class="workspace-dropdown workspace-dropdown--wide" id="systemMenu" role="menu">
                                        <div class="dropdown-section">
                                            <h4 class="dropdown-title">Migration</h4>
                                            <button class="dropdown-item" onclick="startMigration()">Migration starten</button>
                                            <button class="dropdown-item" onclick="loadMigration()">Migration laden</button>
                                            <button class="dropdown-item" onclick="migrateData()">Daten migrieren</button>
                                            <div id="migration-status" class="migration-status"></div>
                                        </div>
                                        <div class="dropdown-section">
                                            <h4 class="dropdown-title">Speicher</h4>
                                            <div class="storage-compact">
                                                <div class="storage-status">
                                                    <span id="storageModeIndicator"></span>
                                                    <button id="switchStorageButton" class="btn btn-secondary btn-tight">Wechseln</button>
                                                </div>
                                                <div id="storageMonitor" class="storage-monitor">
                                                    <div class="progress-bar"><div class="progress-fill" id="storageUsageFill"></div></div>
                                                    <div class="storage-info">
                                                        <span id="storageUsageLabel"></span>
                                                        <span id="lastCleanupLabel"></span>
                                                    </div>
                                                </div>
                                                <div class="storage-actions">
                                                    <button id="openStorageFolderButton" class="btn btn-secondary btn-tight" onclick="openStorageFolder()">📂 Speicherordner</button>
                                                    <button id="cleanupButton" class="btn btn-secondary btn-tight">Aufräumen</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="toolbar-group toolbar-group--search" aria-labelledby="toolbarSearchTitle">
                        <div class="group-main">
                            <h3 id="toolbarSearchTitle" class="group-title">Suche &amp; Verlauf</h3>
                            <button id="subtitleSearchAllButtonInline" class="btn btn-secondary" title="Sucht fehlende deutsche Texte im gesamten Projekt">UT-Suche alles</button>
                        </div>
                        <div class="group-body">
                            <div class="search-bar">
                                <input type="text" class="search-input" placeholder="Live-Suche: Dateiname oder Text... (Groß-/Kleinschreibung, Punkte ignoriert)" id="searchInput">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                            <div class="search-options copy-options">
                                <label class="copy-option"><input type="checkbox" id="restTranslationCheckbox"> Reste-Modus</label>
                                <label class="copy-option"><input type="checkbox" id="copyIncludeTime" checked> Zeit voranstellen</label>
                                <label class="copy-option"><input type="checkbox" id="copyAddDashes"> --- anhängen</label>
                                <label class="copy-option"><input type="checkbox" id="copyAddExtremeSpeed"> „extrem schnell reden“ ergänzen</label>
                            </div>
                            <div class="search-meta">
                                <div class="sort-controls">
                                    <span class="sort-label">Sortierung:</span>
                                    <button class="sort-btn active" onclick="sortTable('position', event)">Position</button>
                                    <button class="sort-btn" onclick="sortTable('filename', event)">Dateiname</button>
                                    <button class="sort-btn" onclick="sortTable('folder', event)">Ordner</button>
                                    <button class="sort-btn" onclick="sortTable('completion', event)">Fertig</button>
                                </div>
                                <div class="progress-info">
                                    <div class="progress-stat" id="totalProgress">0% vollständig</div>
                                    <div class="progress-stat" id="folderProgress">0 Ordner</div>
                                    <div class="progress-stat" id="globalProjectProgress">0% gesamt</div>
                                    <div class="progress-stat clickable" id="emoProgress" title="Leere und fehlerhafte Emo-Texte neu generieren">🟣 0 | 0 | 0</div>
                                </div>
                            </div>
                            <div class="search-progress">
                                <div class="progress-bar" id="globalProjectBar">
                                    <div class="progress-fill" id="globalProjectFill"></div>
                                </div>
                                <div class="project-playback">
                                    <button id="projectPlayPauseBtn" onclick="toggleProjectPlayback()">▶</button>
                                    <button id="projectStopBtn" onclick="stopProjectPlayback()">⏹</button>
                                    <button id="numberPrevBtn" onclick="goToPreviousNumber()" title="Eine Nummer zurück">▲</button>
                                    <button id="numberNextBtn" onclick="goToNextNumber()" title="Eine Nummer weiter">▼</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </header>

<!-- =========================== PROJECT META BAR START =========================== -->
<div class="project-meta-bar" id="projectMetaBar" style="display:none;">
    <span class="meta-project" id="metaProjectName"></span>
    <span class="meta-label">| Level:</span>
    <span id="metaLevelName"></span>
    <button class="copy-level-btn" onclick="copyLevelName()">⧉</button>
    <span class="meta-label">| Teil:</span>
    <span id="metaPartNumber"></span>
</div>
<!-- =========================== PROJECT META BAR END =========================== -->



            <!-- Scan Progress -->
            <div class="scan-progress" id="scanProgress">
                <div class="scan-status" id="scanStatus">Scanne Dateien...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- Übersetzungsfortschritt -->
            <div class="translate-progress" id="translateProgress">
                <div class="translate-status" id="translateStatus">Übersetze...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="translateFill"></div>
                </div>
            </div>

            <!-- Globale Untertitel-Suche -->
            <div class="subtitle-search-progress" id="subtitleSearchProgress">
                <div class="subtitle-search-status" id="subtitleSearchStatus">Suche Untertitel...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="subtitleSearchFill"></div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div id="emptyState" class="empty-state">
                    <h3>Keine Dateien im Projekt</h3>
                    <p>Füge Dateien über die Suche oder das Eingabefeld hinzu.</p>
                    <p style="font-size: 14px; color: #888; margin-top: 10px;">
                        💡 Tipps:<br>
                        • Doppelklick auf Zeilennummern (#) um Position zu ändern<br>
                        • Tab/Shift+Tab für Navigation zwischen Textfeldern<br>
                        • Rechtsklick für Kontext-Menü<br>
                        • Leertaste für Audio-Wiedergabe (wenn Zeile ausgewählt)
                    </p>
                </div>
                <!-- Tabelle mit kompakten Spalten: EN/DE und Aktionen zusammengeführt -->
                <table id="fileTable" style="display: none;">
<thead>
    <tr>
        <th width="30">↕</th>
        <th width="50" title="Doppelklick auf Nummer um Position zu ändern">#</th>
        <th class="sortable">Dateiname</th>
        <th class="sortable">Ordner</th>
        <th width="40" title="Speicherort">Speicher</th>
        <th width="60"><div class="version-score-header">Version<br>Score</div></th>
        <th>EN/DE Text</th>
        <th width="50">UT-Suche</th>
        <th width="90" title="Pfad der EN- und DE-Datei">Pfad</th>
        <th width="40" title="Längenvergleich">Länge</th>
        <th width="130">Aktionen</th>
    </tr>
</thead>
                    <tbody id="fileTableBody"></tbody>
                </table>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-message">
                    <div class="save-indicator"></div>
                    <span id="statusText">Bereit</span>
                </div>
                <div class="status-info">
                    <span id="fileCount">0 Dateien</span> |
                    <span id="selectedCount">0 ausgewählt</span> |
                    <span id="projectFolderPath">sounds</span> |
                    <span id="accessStatus" class="access-status" onclick="handleAccessStatusClick()" title="Klicken um Dateiberechtigungen zu erneuern">
                        📂 Keine Auswahl
                    </span>
                </div>
            </div>
        </main>
    </div>

    <!-- Version Menu -->
    <div class="context-menu" id="versionMenu">
        <div class="context-menu-item" onclick="selectVersion(1)">Version 1</div>
        <div class="context-menu-item" onclick="selectVersion(2)">Version 2</div>
        <div class="context-menu-item" onclick="selectVersion(3)">Version 3</div>
        <div class="context-menu-item" onclick="selectVersion(4)">Version 4</div>
        <div class="context-menu-item" onclick="selectVersion(5)">Version 5</div>
        <div class="context-menu-item" onclick="selectVersion(6)">Version 6</div>
        <div class="context-menu-item" onclick="selectVersion(7)">Version 7</div>
        <div class="context-menu-item" onclick="selectVersion(8)">Version 8</div>
        <div class="context-menu-item" onclick="selectVersion(9)">Version 9</div>
        <div class="context-menu-item" onclick="selectVersion(10)">Version 10</div>
        <div class="context-menu-item" onclick="selectVersion('custom')">Benutzerdefiniert...</div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuAction('play')">
            <span>▶</span> Audio abspielen
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('copyEN')">
            <span>📄</span> EN Text kopieren
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('copyDE')">
            <span>📄</span> DE Text kopieren
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('pasteEN')">
            <span>📋</span> In EN Text einfügen
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('pasteDE')">
            <span>📋</span> In DE Text einfügen
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('uploadDE')">
            <span>⬆️</span> DE-Datei hochladen
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('history')">
            <span>🕒</span> Historie
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('openFolder')">
            <span>📁</span> In Ordner-Browser öffnen
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="contextMenuAction('delete')">
            <span>🗑️</span> Datei löschen
        </div>
    </div>

    <!-- Auto-Übersetzungs-Menü -->
    <div class="context-menu" id="autoTransMenu">
        <div class="context-menu-item" onclick="autoTransMenuAction('line')">
            <span>🔁</span> Übersetzung für diese Zeile
        </div>
        <div class="context-menu-item" onclick="autoTransMenuAction('all')">
            <span>🔁</span> Übersetzung für alle Zeilen
        </div>
    </div>

    <!-- Project Context Menu -->
    <div class="context-menu" id="projectContextMenu">
        <div class="context-menu-item" onclick="projectMenuAction('edit')">
            <span>⚙️</span> Projekt bearbeiten
        </div>
        <div class="context-menu-item" onclick="projectMenuAction('analyze')">
            <span>🔍</span> Projekt analysieren
        </div>
        <div class="context-menu-item danger" onclick="projectMenuAction('delete')">
            <span>🗑️</span> Projekt löschen
        </div>
    </div>

    <!-- Level Context Menu -->
    <div class="context-menu" id="levelContextMenu">
        <div class="context-menu-item" onclick="levelMenuAction('edit')">
            <span>⚙️</span> Level bearbeiten
        </div>
        <div class="context-menu-item" onclick="levelMenuAction('quickProject')">
            <span>➕</span> Schnellprojekt
        </div>
        <div class="context-menu-item" onclick="levelMenuAction('exportDebug')">
            <span>🐞</span> Debug-Bericht exportieren
        </div>
        <div class="context-menu-item danger" onclick="levelMenuAction('delete')">
            <span>🗑️</span> Level löschen
        </div>
    </div>

    <!-- Chapter Context Menu -->
    <div class="context-menu" id="chapterContextMenu">
        <div class="context-menu-item" onclick="chapterMenuAction('edit')">
            <span>⚙️</span> Kapitel bearbeiten
        </div>
        <div class="context-menu-item" onclick="chapterMenuAction('quickLevel')">
            <span>➕</span> Schnell-Level
        </div>
        <div class="context-menu-item danger" onclick="chapterMenuAction('delete')">
            <span>🗑️</span> Kapitel löschen
        </div>
    </div>

    <!-- Import Dialog -->
    <div class="dialog-overlay hidden" id="importDialog">
        <div class="dialog">
            <h3>📥 Daten importieren</h3>
            <p style="margin-bottom: 15px; color: #999;">
                Unterstützte Formate:<br>
                • Wiki-Tabelle (automatische Spalten-Erkennung)<br>
                • Pipe-Liste: <code>Dateiname|EN Text|DE Text</code><br>
                • Der Import erkennt automatisch, welche Spalte die Dateinamen enthält
            </p>
            <textarea id="importData" placeholder="Füge hier deine Daten ein..."></textarea>
            
            <!-- Column Selection (hidden initially) -->
            <div id="columnSelection" style="display: none; margin-top: 20px; padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 6px;">
                <h4 style="color: #ff6b1a; margin-bottom: 15px;">📋 Spalten-Zuordnung</h4>
                <p style="margin-bottom: 15px; color: #999; font-size: 13px;">
                    Bitte wählen Sie aus, welche Spalten welche Inhalte enthalten:
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #ccc;">Dateinamen-Spalte:</label>
                    <select id="filenameColumn" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #e0e0e0;" onchange="updatePreviewHighlighting()">
                        <option value="">-- Bitte auswählen --</option>
                    </select>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                        💡 Intelligente Erkennung basierend auf Datenbank und Patterns
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #ccc;">Englischer Text-Spalte:</label>
                    <select id="englishColumn" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #e0e0e0;" onchange="updatePreviewHighlighting()">
                        <option value="">-- Bitte auswählen --</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #ccc;">Deutsche Text-Spalte (optional):</label>
                    <select id="germanColumn" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #e0e0e0;" onchange="updatePreviewHighlighting()">
                        <option value="">-- Keine / Nicht vorhanden --</option>
                    </select>
                </div>
                
                <!-- Preview Table -->
                <div id="previewTable" style="margin-top: 15px;">
                    <h5 style="color: #ff6b1a; margin-bottom: 10px;">🔍 Vorschau (erste 3 Zeilen):</h5>
                    <div style="overflow-x: auto; max-height: 200px; border: 1px solid #444; border-radius: 4px;">
                        <table id="previewTableContent" style="width: 100%; font-size: 12px;">
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeImportDialog()">Abbrechen</button>
                <button class="btn" id="analyzeDataBtn" onclick="analyzeImportData()">Analysieren</button>
                <button class="btn btn-success" id="startImportBtn" onclick="startImportProcess()" style="display: none;">Import starten</button>
            </div>
        </div>
    </div>

    <!-- Closecaption Import Dialog -->
    <div class="dialog-overlay hidden" id="ccImportDialog">
        <div class="dialog">
            <h3>📥 Untertitel importieren</h3>
            <p>closecaption_english.txt: <span id="ccStatusEn"></span></p>
            <p>closecaption_german.txt: <span id="ccStatusDe"></span></p>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeCcImportDialog()">Abbrechen</button>
                <button class="btn btn-success" onclick="importClosecaptions()">Import starten</button>
            </div>
        </div>
    </div>

    <!-- Folder Browser Dialog -->
    <div class="dialog-overlay folder-browser-dialog hidden" id="folderBrowserDialog">
        <div class="dialog">
<!-- =========================== DIALOG CLOSE BTN START =========================== -->
<button class="dialog-close-btn" onclick="closeFolderBrowser()">×</button>
<!-- =========================== DIALOG CLOSE BTN END =========================== -->
    
            <h3 id="folderBrowserTitle">📁 Ordner durchsuchen</h3>
            <p style="margin-bottom: 15px; color: #999;" id="folderBrowserDescription">
                Durchsuchen Sie alle verfügbaren Ordner aus der Datenbank und fügen Sie Dateien zu Ihrem Projekt hinzu.
            </p>
            
<!-- =========================== LEVEL STATS PANEL START =========================== -->
<details class="level-stats" id="levelStatsPanel">
    <summary>📊 Übersetzungs-Statistiken pro Level</summary>
    <div id="levelStatsContent" style="margin-top:15px;"></div>
</details>
<!-- =========================== LEVEL STATS PANEL END =========================== -->

            
            <!-- Back button (hidden initially) -->
            <button class="folder-back-btn" id="folderBackBtn" onclick="showFolderGrid()" style="display: none;">
                ← Zurück zur Ordnerübersicht
            </button>
            
            <!-- Folder Grid -->
            <div class="folder-grid" id="folderGrid"></div>
            
            <!-- Folder Files View (hidden initially) -->
            <div class="folder-files-view" id="folderFilesView"></div>
            
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="copyFolderReport()">Bericht</button>
                <button class="btn btn-secondary" onclick="closeFolderBrowser()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Backup Dialog -->
    <div class="dialog-overlay hidden" id="backupDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeBackupDialog()">×</button>
            <h3>💾 Backups</h3>
            <div id="backupList" style="margin-bottom:15px;"></div>
            <h4>Sound-ZIP-Backups</h4>
            <div id="soundBackupList" style="margin-bottom:15px;"></div>
            <div class="translate-progress" id="soundBackupProgress">
                <div class="translate-status" id="soundBackupStatus"></div>
                <div class="progress-bar"><div class="progress-fill" id="soundBackupFill"></div></div>
            </div>
            <div style="margin-bottom:15px;">
                <label>Intervall (Minuten):
                    <input type="number" id="backupInterval" min="1" style="width:60px;">
                </label>
                <label style="margin-left:10px;">Anzahl Backups:
                    <input type="number" id="backupLimit" min="1" style="width:60px;">
                </label>
                <label style="margin-left:10px;">Zeilenende:
                    <select id="lineEndingSelect" style="width:70px;">
                        <option value="LF">LF</option>
                        <option value="CRLF">CRLF</option>
                    </select>
                </label>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="createBackup(true)">Backup erstellen</button>
                <button class="btn btn-secondary" onclick="createSoundBackup()">Sound-Backup erstellen</button>
                <button class="btn btn-secondary" onclick="initiateBackupUpload()">Backup hochladen</button>
                <button class="btn btn-secondary" onclick="openBackupFolder()">Ordner öffnen</button>
                <button class="btn btn-secondary" onclick="closeBackupDialog()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- ElevenLabs API Dialog -->
    <div class="dialog-overlay hidden" id="apiDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeApiDialog()">×</button>
            <h3>🔊 ElevenLabs API</h3>
            <div class="customize-field api-key-field">
                <label>API-Key:</label>
                <input type="password" id="apiKeyInput" style="width:55%;" oninput="validateApiKey()">
                <button class="btn eye-btn" onclick="toggleApiKey()">👁</button>
                <button class="btn" id="testApiKeyBtn" onclick="testApiKey()">API-Key testen</button>
                <span id="apiKeyStatus" class="status-indicator"></span>
            </div>
            <div id="voiceIdList" class="voice-id-list"></div>
            <div id="customVoicesList" class="custom-voices-list"></div>
            <h4>Aktuelle Dubbing-Standardwerte</h4>
            <ul id="voiceSettingsDisplay" class="voice-defaults-list"></ul>
            <div class="dialog-buttons">
                <button class="btn" onclick="testVoiceIds()">Voice-IDs testen</button>
                <button class="btn" onclick="clearAllVoiceIds()">Alle zurücksetzen</button>
                <button class="btn" onclick="addCustomVoice()">Neue Stimme</button>
                <button class="btn btn-secondary" onclick="closeApiDialog()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveApiSettings()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- ChatGPT API Dialog -->
    <div class="dialog-overlay hidden" id="gptApiDialog">
        <div class="dialog">
            <button class="dialog-close-btn" onclick="closeGptApiDialog()">×</button>
            <h3>💬 ChatGPT API</h3>
            <div class="customize-field api-key-field">
                <label>API-Key:</label>
                <input type="password" id="openaiKeyInput" style="width:55%;">
                <button class="btn eye-btn" onclick="toggleOpenaiKey()">👁</button>
                <button class="btn" id="testOpenaiKeyBtn" onclick="testGptApiKey()">Key testen</button>
                <span id="openaiKeyStatus" class="status-indicator"></span>
            </div>
            <div class="customize-field">
                <label>GPT-Modell:</label>
                <select id="gptModelSelect" style="width:55%;" disabled></select>
                <button class="btn" id="refreshModelsBtn" title="Verfügbare Modelle vom Server laden">↻</button>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeGptApiDialog()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveGptApiSettings()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- GPT Start Dialog -->
    <div class="dialog-overlay hidden" id="gptStartDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeGptStartDialog()">×</button>
            <h3>Bewerten (GPT)</h3>
            <p id="gptStartInfo"></p>
            <ul id="gptStartSpeakers" class="debug-info-list"></ul>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeGptStartDialog()">Abbrechen</button>
                <button class="btn btn-success" onclick="startGptScoring()">Start</button>
            </div>
        </div>
    </div>

    <!-- GPT Prompt Dialog -->
    <div class="dialog-overlay hidden" id="gptPromptDialog">
        <div class="dialog gpt-test-dialog">
            <button class="dialog-close-btn" onclick="closeGptPromptDialog()">×</button>
            <h3>GPT-Test</h3>
            <div id="gptTestTabs" class="gpt-tabs"></div>
            <div class="prompt-result-container">
                <textarea id="gptPromptArea" readonly></textarea>
                <textarea id="gptResultArea" readonly></textarea>
                <div class="summary-table-wrapper">
                    <table id="gptSummaryTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Datei</th>
                                <th>Ordner</th>
                                <th>Bewertung</th>
                                <th>Vorschlag</th>
                                <th>Kommentar</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeGptPromptDialog()">Schließen</button>
                <button class="btn btn-success" id="gptPromptSend" onclick="sendGptPrompt()">Senden</button>
                <button class="btn btn-blue" id="gptPromptInsert" onclick="insertGptResults()" disabled>Einfügen</button>
            </div>
        </div>
    </div>

    <!-- Neue Stimme Dialog -->
    <div class="dialog-overlay hidden" id="addVoiceDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeAddVoiceDialog()">×</button>
            <h3>🆕 Neue Stimme</h3>
            <div class="customize-field">
                <label>Voice-ID:</label>
                <input type="text" id="newVoiceId" style="width:70%;">
            </div>
            <div class="customize-field">
                <label>Name:</label>
                <input type="text" id="newVoiceName" style="width:70%;">
                <button class="btn" onclick="fetchNewVoiceName()">Name abrufen</button>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeAddVoiceDialog()">Abbrechen</button>
                <button class="btn btn-success" onclick="confirmAddVoice()">Hinzufügen</button>
            </div>
        </div>
    </div>

    <!-- History Dialog -->
    <div class="dialog-overlay hidden" id="historyDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeHistoryDialog()">×</button>
            <h3>🕒 Historie</h3>
            <div id="historyList" style="margin-bottom:15px;"></div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeHistoryDialog()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- DE Edit Dialog -->
    <div class="dialog-overlay hidden" id="deEditDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeDeEdit()" title="Fenster schließen">×</button>
            <div class="edit-header">
                <h3>✂️ DE-Audio bearbeiten <span id="deEditSaveInfo" class="save-info"></span></h3>
                <!-- Zusätzliche Aktionsleiste im Kopfbereich -->
                <div class="edit-header-actions">
                    <button class="btn btn-secondary" onclick="resetDeEdit()" title="Letzte Speicherung wiederherstellen">Zurücksetzen</button>
                    <button class="btn btn-blue" onclick="applyDeEdit()" title="Bearbeitung speichern und geöffnet lassen">Speichern</button>
                    <button class="btn btn-primary" onclick="applyDeEdit(true)" title="Speichern und den Dialog schließen">Speichern &amp; schließen</button>
                </div>
            </div>
            <div class="wave-toolbar" id="waveToolbar">
                <div class="wave-slider wave-zoom-slider">
                    <button type="button" class="wave-toolbar-btn" id="waveZoomOutBtn" title="Zoom verkleinern">−</button>
                    <label for="waveZoomRange">Zoom</label>
                    <input type="range" id="waveZoomRange" min="0.8" max="2.5" step="0.1">
                    <span id="waveZoomDisplay">100%</span>
                    <button type="button" class="wave-toolbar-btn" id="waveZoomInBtn" title="Zoom vergrößern">+</button>
                </div>
                <div class="wave-slider wave-position-slider">
                    <button type="button" class="wave-toolbar-btn" id="waveScrollLeftBtn" title="Nach links springen">⟵</button>
                    <label for="waveScrollRange">Position</label>
                    <input type="range" id="waveScrollRange" min="0" max="100" step="1" value="0">
                    <span id="waveScrollDisplay">0%</span>
                    <button type="button" class="wave-toolbar-btn" id="waveScrollRightBtn" title="Nach rechts springen">⟶</button>
                </div>
                <div class="wave-slider">
                    <label for="waveHeightRange">Höhe</label>
                    <input type="range" id="waveHeightRange" min="60" max="200" step="10" value="80">
                    <span id="waveHeightDisplay">80px</span>
                </div>
                <label class="wave-sync-label"><input type="checkbox" id="waveSyncScroll"> Scroll koppeln</label>
                <div class="wave-toolbar-buttons">
                    <button id="waveFitFullBtn" class="btn btn-secondary" type="button" title="Gesamtes Audio einpassen">↔ Alles zeigen</button>
                    <button id="waveFocusSelectionBtn" class="btn btn-secondary" type="button" title="Auswahl in den Fokus holen">🎯 Auswahl</button>
                </div>
            </div>
            <div class="wave-area">
                <div class="wave-block wave-block-original">
                    <span class="wave-label" id="waveLabelOriginal">EN (Original)</span>
                    <div class="wave-controls">
                        <div class="wave-viewport" id="waveOriginalViewport">
                            <div class="wave-scroll" id="waveOriginalScroll">
                                <canvas id="waveOriginal" width="500" height="80" class="wave-canvas"></canvas>
                                <div class="wave-ruler" id="waveOriginalRuler"></div>
                            </div>
                        </div>
                        <div class="wave-buttons">
                            <button id="playOrigPreview" class="de-play-btn" onclick="playOriginalPreview()" title="Original abspielen" aria-label="Original abspielen">▶</button>
                            <button class="de-stop-btn" onclick="stopEditPlayback()" title="Wiedergabe stoppen" aria-label="Wiedergabe stoppen">⏹</button>
                        </div>
                    </div>
                    <!-- EN-Text unter der Original-Welle -->
                    <div id="editEnText" class="wave-text"></div>
                </div>
                <!-- Steuerung zum Runterkopieren des markierten EN-Bereichs -->
                <div class="insert-en-section">
                    <div class="insert-controls">
                        <label>Start EN (ms): <input type="number" id="enSegStart" value="0" step="100"></label>
                        <label>Ende EN (ms): <input type="number" id="enSegEnd" value="0" step="100"></label>
                        <label>Einfügen bei:
                            <select id="enInsertPos">
                                <option value="cursor">Cursor</option>
                                <option value="start">Anfang</option>
                                <option value="end">Ende</option>
                            </select>
                        </label>
                        <button id="copyEnBtn" class="btn btn-secondary" onclick="insertEnglishSegment()" title="Markierten EN-Abschnitt in DE-Audio kopieren">⬇️ Kopieren</button>
                    </div>
                </div>
                <div class="wave-block wave-block-edited">
                    <span class="wave-label" id="waveLabelEdited">DE (bearbeiten)</span>
                    <div class="wave-controls">
                        <div class="wave-viewport" id="waveEditedViewport">
                            <div class="wave-scroll" id="waveEditedScroll">
                                <canvas id="waveEdited" width="500" height="80" class="wave-canvas"></canvas>
                                <div class="wave-ruler" id="waveEditedRuler"></div>
                            </div>
                        </div>
                        <div class="wave-buttons">
                            <button id="playDePreview" class="de-play-btn" onclick="playDePreview()" title="DE-Vorschau abspielen" aria-label="DE-Vorschau abspielen">▶</button>
                            <button class="de-stop-btn" onclick="stopEditPlayback()" title="Wiedergabe stoppen" aria-label="Wiedergabe stoppen">⏹</button>
                        </div>
                    </div>
                    <!-- DE-Text und Emotional-Text unter der Bearbeitungs-Welle -->
                    <div id="editDeText" class="wave-text"></div>
                    <div id="editEmoText" class="wave-text"></div>
                </div>
            </div>
            <div class="edit-layout">
                <!-- Linke Seite: Bereiche & Timing -->
                <section class="timing-section">
                    <div class="quick-actions" aria-label="Schnellzugriff auf häufige Werkzeuge">
                        <div class="quick-header">
                            <h4 class="section-headline">Schnellzugriff</h4>
                            <p class="quick-subheadline">Die wichtigsten Schritte stehen als kompakte Buttons bereit und markieren beim Klick die passenden Detailbereiche.</p>
                        </div>
                        <div class="quick-toolbar" role="toolbar" aria-label="Schnellzugriffswerkzeuge">
                            <button id="quickFocusTrim" class="quick-btn" type="button" title="Trimmbereiche bearbeiten" aria-label="Trimmbereiche bearbeiten">
                                <span class="quick-icon" aria-hidden="true">✂️</span>
                                <span class="quick-text">Trim</span>
                            </button>
                            <button id="quickAutoTrim" class="quick-btn" type="button" title="Stille automatisch erkennen" aria-label="Stille automatisch erkennen">
                                <span class="quick-icon" aria-hidden="true">⚡</span>
                                <span class="quick-text">Auto</span>
                            </button>
                            <button id="quickTempoMatch" class="quick-btn" type="button" title="Tempo automatisch auf EN-Zeit anpassen" aria-label="Tempo automatisch auf EN-Zeit anpassen">
                                <span class="quick-icon" aria-hidden="true">⏱️</span>
                                <span class="quick-text">Tempo</span>
                            </button>
                            <button id="quickVolumeMatch" class="quick-btn" type="button" title="Lautstärke an EN anpassen" aria-label="Lautstärke an EN anpassen">
                                <span class="quick-icon" aria-hidden="true">🔊</span>
                                <span class="quick-text">Pegel</span>
                            </button>
                            <button id="quickRadioEffect" class="quick-btn" type="button" title="Funkgerät-Effekt anwenden" aria-label="Funkgerät-Effekt anwenden">
                                <span class="quick-icon" aria-hidden="true">📻</span>
                                <span class="quick-text">Funk</span>
                            </button>
                        </div>
                    </div>
                    <div class="timing-grid">
                        <!-- Karte Trimmen -->
                        <div class="timing-card trim-card">
                            <h4>Trimmen</h4>
                            <div class="trim-fields">
                                <div class="field">
                                    <label for="editStart">Start (ms)</label>
                                    <div class="input-unit"><input type="number" id="editStart" value="0" step="100"><span class="unit">ms</span></div>
                                </div>
                                <div class="field">
                                    <label for="editEnd">Ende (ms)</label>
                                    <div class="input-unit"><input type="number" id="editEnd" value="0" step="100"><span class="unit">ms</span></div>
                                </div>
                            </div>
                            <button id="autoTrimBtn" class="copy-btn" title="Stille automatisch erkennen">Auto</button>
                        </div>
                        <!-- Karte Ignorierbereiche -->
                        <div class="timing-card ignore-card">
                            <h4>Ignorierbereiche</h4>
                            <div id="ignoreList"></div>
                            <div class="ignore-buttons">
                                <button class="btn btn-secondary" onclick="adjustIgnoreRanges(-50)" title="Ignorierbereich verkürzen">◀ Kürzer</button>
                                <button class="btn btn-secondary" onclick="adjustIgnoreRanges(50)" title="Ignorierbereich verlängern">Länger ▶</button>
                            </div>
                        </div>
                        <!-- Karte Pausen entfernen -->
                        <div class="timing-card pause-card">
                            <h4>Pausen entfernen</h4>
                            <label class="checkbox-line" title="Längere Pausen automatisch entfernen"><input type="checkbox" id="autoIgnoreChk"> Pausen &gt; <span class="input-unit"><input type="number" id="autoIgnoreMs" value="400" step="100" style="width:70px;"><span class="unit">ms</span></span> entfernen</label>
                        </div>
                        <!-- Karte Stille-Bereiche -->
                        <div class="timing-card silence-card">
                            <h4>Stille-Bereiche</h4>
                            <div id="silenceList"></div>
                            <div class="silence-buttons">
                                <button class="btn btn-secondary" onclick="markSilenceRange('start')" title="Startpunkt setzen">Start</button>
                                <button class="btn btn-secondary" onclick="markSilenceRange('end')" title="Endpunkt setzen">Ende</button>
                                <button class="btn btn-danger" onclick="clearSilenceTemp()" title="Markierung aufheben">⟲</button>
                            </div>
                            <div class="silence-buttons">
                                <button class="btn btn-secondary" onclick="adjustSilenceRanges(-50)" title="Stillebereich verkürzen">◀ Kürzer</button>
                                <button class="btn btn-secondary" onclick="adjustSilenceRanges(50)" title="Stillebereich verlängern">Länger ▶</button>
                            </div>
                            <label title="Markierung übernehmen">Übernehmen nach: <span class="input-unit"><input type="number" id="silenceApplyDelay" value="0" step="100" style="width:70px;"><span class="unit">ms</span></span></label>
                            <div class="silence-actions">
                                <button class="btn btn-secondary" onclick="applySilenceRange()" title="Bereich übernehmen">Übernehmen</button>
                                <button class="btn btn-danger" onclick="deleteSilenceRange()" title="Letzten Bereich löschen">Löschen</button>
                            </div>
                        </div>
                        <!-- Karte Bereiche verschmelzen -->
                        <div class="timing-card merge-card">
                            <h4>Bereiche verschmelzen</h4>
                            <label title="Bereiche verschmelzen, wenn Abstand kleiner ist">Abstand &lt; <span class="input-unit"><input type="number" id="mergeGapMs" value="120" step="10" style="width:70px;"><span class="unit">ms</span></span></label>
                            <label title="Bereiche verschmelzen, wenn Gesamtzeit kleiner ist">Gesamt &lt; <span class="input-unit"><input type="number" id="mergeTotalMs" value="500" step="10" style="width:70px;"><span class="unit">ms</span></span></label>
                            <label title="Zeitspanne verschmelzen">Bereiche zusammenlegen: <span class="input-unit"><input type="number" id="mergeRangeMs" value="80" step="10" style="width:70px;"><span class="unit">ms</span></span></label>
                            <button class="btn btn-secondary" onclick="mergeSilenceRanges()" title="Überlappende Bereiche vereinen">Bereiche mergen</button>
                        </div>
                        <!-- Karte Tempo -->
                        <div class="timing-card tempo-card">
                            <h4>Tempo</h4>
                            <label class="checkbox-line" title="Passt die Geschwindigkeit des DE-Audios an"><input type="checkbox" id="autoTempoChk"> Tempo automatisch an EN anpassen</label>
                            <div class="tempo-row">
                                <span class="tempo-icon">⏱️</span>
                                <button id="tempoMinusBtn" class="copy-btn" title="Tempo in kleinen Schritten verringern">➖</button>
                                <input type="range" id="tempoRange" min="1" max="3" step="0.01" value="1" title="Aktuelles Wiedergabetempo">
                                <button id="tempoPlusBtn" class="copy-btn" title="Tempo in kleinen Schritten erhöhen">➕</button>
                                <span id="tempoDisplay" class="tempo-value">1.00</span>
                            </div>
                            <div class="tempo-auto">
                                <button id="tempoAutoBtn" class="copy-btn" title="Tempo auf Minimum setzen">Auto</button>
                                <button id="tempoAutoMatchBtn" class="copy-btn" title="Tempo automatisch auf EN-Zeit anpassen">Auto</button>
                                <span id="tempoInfo"></span><span id="tempoEnInfo"></span>
                            </div>
                        </div>
                        <!-- Button Anpassen & Anwenden -->
                        <button class="btn btn-secondary" id="autoAdjustBtn" title="Pausen kürzen und Tempo angleichen">🎯 Anpassen &amp; Anwenden</button>
                    </div>
                </section>
                <!-- Rechte Seite: Effekte & Optionen -->
                <section class="effects-section">
                    <div class="effect-scroll">
                        <fieldset class="effect-group">
                            <legend>🔊 Lautstärke angleichen</legend>
                            <button id="volumeMatchBoxBtn" class="effect-btn" onclick="applyVolumeMatch()" title="Pegel an EN anpassen">Lautstärke angleichen</button>
                        </fieldset>

                        <fieldset class="effect-group">
                            <legend>📡 Funkgerät-Effekt</legend>
                            <div class="radio-settings">
                                <label title="Mischverhältnis">Wet: <span id="radioStrengthDisplay"></span>
                                    <input type="range" id="radioStrength" min="0" max="1" step="0.05">
                                </label>
                                <label title="Hochpassfrequenz">Highpass (Hz):
                                    <input type="number" id="radioHighpass" min="0" max="1000" step="50">
                                </label>
                                <label title="Tiefpassfrequenz">Lowpass (Hz):
                                    <input type="number" id="radioLowpass" min="1000" max="6000" step="50">
                                </label>
                                <label title="Sättigungsgrad">Sättigung: <span id="radioSaturationDisplay"></span>
                                    <input type="range" id="radioSaturation" min="0" max="1" step="0.05">
                                </label>
                                <label title="Rauschpegel in dBFS">Rauschen (dB):
                                    <input type="number" id="radioNoise" min="-60" max="0" step="1">
                                </label>
                                <label title="Häufigkeit der Knackser">Knackser: <span id="radioCrackleDisplay"></span>
                                    <input type="range" id="radioCrackle" min="0" max="1" step="0.05">
                                </label>
                                <div class="radio-preset">
                                    <select id="radioPresetSelect" title="Gespeicherte Presets"></select>
                                    <button id="saveRadioPresetBtn" type="button" title="Aktuelle Einstellungen speichern">💾 Speichern</button>
                                    <button id="deleteRadioPresetBtn" type="button" title="Gewähltes Preset löschen">🗑 Löschen</button>
                                </div>
                            </div>
                            <div class="effect-actions">
                                <button id="radioEffectBoxBtn" class="effect-btn" onclick="applyRadioEffect()" title="Funkgerät-Effekt anwenden">Funkgerät-Effekt anwenden</button>
                                <!-- Setzt nur diesen Effekt zurück -->
                                <button class="btn-reset-settings" onclick="resetRadioSettings()" title="Setzt nur diesen Effekt zurück">⟳ Standardwerte</button>
                            </div>
                        </fieldset>

                        <fieldset class="effect-group">
                            <legend>🎚️ Hall-Effekt</legend>
                            <label id="hallToggleLabel" class="effect-toggle" title="Hall-Effekt ein- oder ausschalten"><input type="checkbox" id="hallToggle" onchange="toggleHallEffect(this.checked)"> Aktivieren</label>
                            <div class="hall-settings">
                                <label title="Raumgröße">Room:
                                    <input type="range" id="hallRoom" min="0" max="1" step="0.05">
                                </label>
                                <label title="Mischverhältnis">Wet: <span id="hallAmountDisplay"></span>
                                    <input type="range" id="hallAmount" min="0" max="1" step="0.05">
                                </label>
                                <label title="Vorlaufzeit">Delay (ms):
                                    <input type="number" id="hallDelay" min="0" max="500" step="10">
                                </label>
                            </div>
                            <!-- Setzt nur diesen Effekt zurück -->
                            <button class="btn-reset-settings" onclick="resetHallSettings()" title="Setzt nur diesen Effekt zurück">⟳ Standardwerte</button>
                        </fieldset>

                        <fieldset class="effect-group">
                            <legend>⚡ EM-Störgeräusch</legend>
                            <label id="emiVoiceDampToggleLabel" class="effect-toggle" title="Dämpft das Originalsignal bei Störungen"><input type="checkbox" id="emiVoiceDampToggle" onchange="toggleEmiVoiceDamp(this.checked)"> Sprachdämpfung</label>
                            <div class="emi-settings">
                                <!-- Canvas für die Hüllkurve des Störgeräuschs -->
                                <canvas id="emiEnvelopeCanvas" width="200" height="60"></canvas>
                                <label title="Stärke der Störung">Stärke <span class="info-icon" title="Regelt die Lautstärke der Störung">ℹ️</span>: <span id="emiLevelDisplay"></span>
                                    <input type="range" id="emiLevel" min="0" max="1" step="0.05">
                                </label>
                                <!-- Regler für den Anstiegszeitpunkt -->
                                <label title="Zeitpunkt des starken Anstiegs">Anstieg ab <span class="info-icon" title="Zeitpunkt, ab dem die Störung deutlich lauter wird">ℹ️</span>: <span id="emiRampDisplay"></span>
                                    <input type="range" id="emiRamp" min="0" max="1" step="0.05">
                                </label>
                                <label title="Häufigkeit der Aussetzer">Aussetzer-Häufigkeit <span class="info-icon" title="Wie oft die Verbindung kurz abbricht">ℹ️</span>: <span id="emiDropoutProbDisplay"></span>
                                    <input type="range" id="emiDropoutProb" min="0" max="0.005" step="0.0001">
                                </label>
                                <label title="Dauer eines Aussetzers">Aussetzer-Dauer <span class="info-icon" title="Länge eines einzelnen Aussetzers">ℹ️</span>: <span id="emiDropoutDurDisplay"></span>
                                    <input type="range" id="emiDropoutDur" min="0" max="0.1" step="0.005">
                                </label>
                                <label title="Häufigkeit der Knackser">Knackser-Häufigkeit <span class="info-icon" title="Wahrscheinlichkeit für kurze Knackser">ℹ️</span>: <span id="emiCrackleProbDisplay"></span>
                                    <input type="range" id="emiCrackleProb" min="0" max="0.02" step="0.001">
                                </label>
                                <label title="Lautstärke der Knackser">Knackser-Amplitude <span class="info-icon" title="Lautstärke der Knackser">ℹ️</span>: <span id="emiCrackleAmpDisplay"></span>
                                    <input type="range" id="emiCrackleAmp" min="0" max="1" step="0.05">
                                </label>
                                <label title="Häufigkeit großer Ausreißer">Spike-Häufigkeit <span class="info-icon" title="Wahrscheinlichkeit für starke Ausreißer">ℹ️</span>: <span id="emiSpikeProbDisplay"></span>
                                    <input type="range" id="emiSpikeProb" min="0" max="0.01" step="0.0005">
                                </label>
                                <label title="Lautstärke der Ausreißer">Spike-Amplitude <span class="info-icon" title="Lautstärke der Ausreißer">ℹ️</span>: <span id="emiSpikeAmpDisplay"></span>
                                    <input type="range" id="emiSpikeAmp" min="0" max="1" step="0.05">
                                </label>
                                <label title="Verlauf der Störung">Verlauf <span class="info-icon" title="Form der Lautstärkeentwicklung">ℹ️</span>:
                                    <select id="emiMode">
                                        <option value="constant">Konstant</option>
                                        <option value="up">Anstieg</option>
                                        <option value="updown">Anstieg &amp; Abfall</option>
                                        <option value="down">Abfall</option>
                                    </select>
                                </label>
                            </div>
                            <div class="radio-preset">
                                <select id="emiPresetSelect" title="Gespeicherte Presets"></select>
                                <button id="saveEmiPresetBtn" type="button" title="Aktuelle Einstellungen speichern">💾 Speichern</button>
                                <button id="deleteEmiPresetBtn" type="button" title="Gewähltes Preset löschen">🗑 Löschen</button>
                            </div>
                            <div class="effect-actions">
                                <button id="emiEffectBoxBtn" class="effect-btn" onclick="applyEmiEffect()" title="EM-Störgeräusch anwenden">EM-Störgeräusch anwenden</button>
                                <!-- Setzt nur diesen Effekt zurück -->
                                <button class="btn-reset-settings" onclick="resetEmiSettings()" title="Setzt nur diesen Effekt zurück">⟳ Standardwerte</button>
                            </div>
                        </fieldset>

                        <fieldset class="effect-group">
                            <legend>🚪 Nebenraum-Effekt</legend>
                            <label id="neighborToggleLabel" class="effect-toggle" title="Nebenraum-Effekt ein- oder ausschalten"><input type="checkbox" id="neighborToggle" onchange="toggleNeighborEffect(this.checked)"> Nebenraum-Effekt</label>
                            <label id="neighborHallToggleLabel" class="effect-toggle" title="Hall-Effekt ein- oder ausschalten"><input type="checkbox" id="neighborHallToggle" onchange="toggleNeighborHall(this.checked)"> Hall-Effekt</label>
                            <label id="tableMicToggleLabel" class="effect-toggle" title="Telefon-auf-Tisch-Effekt ein- oder ausschalten"><input type="checkbox" id="tableMicToggle" onchange="toggleTableMicEffect(this.checked)"> Telefon auf Tisch</label>
                            <label for="tableMicRoom" title="Raumtyp für den Telefon-auf-Tisch-Effekt">Raumtyp:</label>
                            <select id="tableMicRoom">
                                <option value="wohnzimmer">Wohnzimmer</option>
                                <option value="buero">Büro</option>
                                <option value="halle">Halle</option>
                                <option value="keller">Keller</option>
                            </select>
                        </fieldset>
                    </div>
                </section>
            </div> <!-- edit-layout Ende -->


            <!-- Schlanke Fußleiste nur mit Zurücksetzen/Speichern -->
            <div class="edit-footer">
                <button class="btn btn-secondary" onclick="resetDeEdit()" title="Letzte Speicherung wiederherstellen">Zurücksetzen</button>
                <button class="btn btn-blue" onclick="applyDeEdit()" title="Bearbeitung speichern und geöffnet lassen">Speichern</button>
                <button class="btn btn-primary" onclick="applyDeEdit(true)" title="Speichern und den Dialog schließen">Speichern &amp; schließen</button>
            </div>
        </div>
    </div>

    <!-- Audio-Segmentierung Dialog -->
    <div class="dialog-overlay hidden" id="segmentDialog">
        <div class="dialog">
            <button class="dialog-close-btn" onclick="closeSegmentDialog()">×</button>
            <h3>🎵 Audio-Datei zuordnen</h3>
            <!-- Upload-Feld reagiert direkt per onchange, falls der Listener fehlt -->
            <input type="file" id="segmentFileInput" accept=".mp3,.wav" onchange="analyzeSegmentFile(event)">
            <div class="segment-progress" id="segmentProgress">
                <div class="segment-status" id="segmentStatus">Analysiere...</div>
                <div class="progress-bar"><div class="progress-fill" id="segmentFill"></div></div>
            </div>
            <button class="btn btn-secondary" onclick="playSegmentFull()" style="margin-top:6px;">▶ Gesamt</button>
            <button class="btn btn-danger" onclick="toggleIgnoreSelectedSegments()" style="margin-top:6px; margin-left:6px;">🚫 Ignorieren</button>
            <canvas id="segmentWaveform" width="600" height="80" style="width:100%; background:#111; margin-top:10px;"></canvas>
            <div id="segmentTextList" style="margin-top:10px;"></div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="resetSegmentDialog()">Neu hochladen</button>
                <button class="btn btn-blue" onclick="exportSegmentsToProject()">Importieren</button>
                <button class="btn btn-secondary" onclick="closeSegmentDialog()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Protokoll Dialog -->
    <div class="dialog-overlay hidden" id="dubbingLogDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeDubbingLog()">×</button>
            <h3>📝 Dubbing-Protokoll</h3>
            <ul id="protocolList" class="protocol-list"></ul>
            <pre id="dubbingLog" style="max-height:200px; overflow:auto; background:#000; color:#0f0; padding:10px;"></pre>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="copyDubbingLog()">Log kopieren</button>
                <button class="btn btn-danger" onclick="clearDubbingLog()">Log löschen</button>
                <button class="btn btn-secondary" onclick="closeDubbingLog()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Missing Folders Dialog -->
    <div class="dialog-overlay hidden" id="missingFoldersDialog">
        <div class="dialog">
<button class="dialog-close-btn" onclick="closeMissingFoldersDialog()">×</button>
            <h3>🚫 Fehlende Ordner</h3>
            <div id="missingFoldersList" style="margin-bottom:15px;"></div>
            <h4>📁 Ordner in der Datenbank</h4>
            <div id="databaseFoldersList" style="margin-bottom:15px;"></div>
            <div class="dialog-buttons">
                <button class="btn btn-danger" id="deleteAllMissingBtn">Alle löschen</button>
                <button class="btn btn-secondary" onclick="closeMissingFoldersDialog()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Word List Dialog -->
    <div class="dialog-overlay hidden" id="wordListDialog">
        <div class="dialog">
            <button class="dialog-close-btn" onclick="closeWordList()">×</button>
            <h3>📚 Wörterbuch</h3>
            <div class="word-list-wrapper">
                <div class="word-list-column">
                    <h4>Übersetzungen</h4>
                    <table id="translationTable" class="word-list-table" style="width:100%; margin-bottom:15px;">
                        <thead>
                            <tr>
                                <th>Englisch</th>
                                <th>Deutsch</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button class="btn btn-secondary" onclick="addTransRow()">+ Zeile</button>
                </div>
                <div class="word-list-column">
                    <h4>Phonetische Umschrift</h4>
                    <table id="phoneticTable" class="word-list-table" style="width:100%; margin-bottom:15px;">
                        <thead>
                            <tr>
                                <th>Englisch</th>
                                <th>Phonetisch</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button class="btn btn-secondary" onclick="addPhonRow()">+ Zeile</button>
                </div>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeWordList()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveWordList()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Copy Assistant Dialog -->
    <div class="dialog-overlay hidden" id="copyAssistantDialog">
        <div class="dialog">
            <button class="dialog-close-btn" onclick="closeCopyAssistant()">×</button>
            <h3>📋 Kopierhilfe</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="copyAssistProgress"></div>
            </div>
            <div id="copyAssistInfo">
                <p><strong>Ordner:</strong> <span id="copyFolder"></span> <button class="copy-btn" onclick="copyAssistCopy('folder')">⧉</button></p>
                <p><strong>ID:</strong> <span id="copyId"></span> <button class="copy-btn" onclick="copyAssistCopy('id')">⧉</button></p>
                <p><strong>Name:</strong> <span id="copyName"></span> <button class="copy-btn" onclick="copyAssistCopy('name')">⧉</button></p>
                <p><strong>EN:</strong> <span id="copyEn"></span> <button class="copy-btn" onclick="copyAssistCopy('en')">⧉</button></p>
                <p><strong>DE:</strong> <span id="copyDe"></span> <button class="copy-btn" onclick="copyAssistCopy('de')">⧉</button></p>
                <p><strong>Emotion:</strong> <span id="copyEmo"></span> <button class="copy-btn" onclick="copyAssistCopy('emo')">⧉</button></p>
            </div>
            <div id="copyAssistStep" style="margin-top:10px; color:#999;"></div>
            <div class="dialog-buttons">
                <span id="copyAssistCount" style="margin-right:auto"></span>
                <button class="btn btn-secondary" onclick="closeCopyAssistant()">Abbrechen</button>
                <button class="btn btn-secondary" onclick="copyAssistPrev()">Zurück</button>
                <button class="btn btn-success" onclick="copyAssistNext()">Weiter</button>
            </div>
        </div>
    </div>

    <!-- Copy Assistant 2 Dialog -->
    <div class="dialog-overlay hidden" id="copyAssistant2Dialog">
        <div class="dialog">
            <button class="dialog-close-btn" onclick="closeCopyAssistant2()">×</button>
            <h3>📋 Kopierhilfe 2</h3>
            <div id="copyAssist2Content" style="text-align:center;">
                <div id="copy2Name" style="font-size:24px; font-weight:bold; margin-bottom:10px;"></div>
                <div id="copy2De" style="margin-bottom:10px;"></div>
                <div id="copy2Emo" style="color:#999;"></div>
            </div>
            <div class="dialog-buttons">
                <span id="copyAssist2Page" style="margin-right:auto"></span>
                <button class="btn btn-secondary" onclick="closeCopyAssistant2()">Abbrechen</button>
                <button class="btn btn-secondary" onclick="copyAssist2Prev()">Zurück</button>
                <button class="btn btn-success" onclick="copyAssist2Next()">Weiter</button>
            </div>
        </div>
    </div>

    <!-- Projekt-Wiedergabe Liste -->
    <div class="dialog-overlay hidden" id="playbackListDialog">
        <div class="dialog playback-dialog">
            <button class="dialog-close-btn" onclick="closePlaybackList()">×</button>
            <h3>🔊 Wiedergabeliste</h3>
            <ul id="playbackList" class="playback-list"></ul>
            <pre id="playbackProtocol" class="playback-protocol"></pre>
            <div class="dialog-buttons">
                <button class="btn" id="playbackPlayBtn" onclick="toggleProjectPlayback()">▶</button>
                <button class="btn btn-secondary" onclick="closePlaybackList()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Audio Player -->
    <audio id="audioPlayer"></audio>
    <input type="file" id="deUploadInput" style="display:none" accept=".mp3,.wav,.ogg" onchange="handleDeUpload(this)">
    <input type="file" id="zipImportInput" style="display:none" accept=".zip" onchange="handleZipImport(this)">
    <input type="file" id="backupUploadInput" style="display:none" accept=".json" onchange="handleBackupUpload(this)">

    <!-- Umschaltbare Debug-Konsole (standardmäßig versteckt) -->
    <details id="debugConsoleWrapper" style="margin:10px 0; display:none;">
        <summary>🛠️ Debug-Konsole</summary>
        <button class="btn btn-secondary" onclick="showFolderDebug()">🐞 Ordner prüfen</button>
        <div id="folderDebug" style="margin:10px 0;"></div>
        <pre id="debugConsole" style="max-height:200px; overflow:auto; background:#000; color:#0f0; padding:5px;"></pre>
    </details>


    <!-- Toast-Meldungen -->
    <div id="toastContainer"></div>

    <!-- Video-Manager mit integriertem Player -->
    <dialog id="videoMgrDialog" class="video-dialog">
        <div class="video-grid">
            <aside id="videoListSection" class="video-bookmarks">
                <h2>📼 Gespeicherte Videos</h2>
                <div class="video-toolbar">
                    <div class="video-search">
                        <input id="videoFilter" placeholder="Suche …" />
                        <button id="closeVideoDlgSmall" class="btn btn-danger close-icon">❌</button>
                    </div>
                    <div class="video-url">
                        <input type="text" id="videoUrlInput" placeholder="YouTube-Link mit Startzeit …">
                        <button id="addVideoBtn" class="btn">+ Hinzufügen</button>
                    </div>
                </div>
                <div id="videoTableWrapper">
                    <div id="videoGrid" class="video-grid-container"></div>
                </div>
            </aside>
        </div>
        <button id="closeVideoDlg" class="dialog-close-btn">×</button>
    </dialog>

    <!-- Versionsanzeige -->
    <!-- Verlinkung zur aktuellen Version -->
    <a id="versionLink" href="https://github.com/Lumorn/hla_translation_tool" target="_blank">v1.40.127</a>

    <script src="src/colorUtils.js"></script>
    <script src="src/fileStorage.js"></script>
    <script src="src/migrationUI.js"></script>
    <script src="src/projectHelpers.js"></script>
    <script src="src/projectSwitch.js"></script>
    <script src="src/calculateProjectStats.js"></script>
    <script src="src/main.js"></script>
    <script type="module" src="renderer.js"></script>
</body>
</html>

